<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Kafka on Kubernetes, the Strimzi way! (Part 3) - Abhishek&#39;s blog (work in progress)</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Kafka on Kubernetes, the Strimzi way! (Part 3)" />
<meta property="og:description" content="Welcome to part three of this blog series!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/kafka-kubernetes-strimzi-3/" />
<meta property="article:published_time" content="2020-07-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-07-07T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kafka on Kubernetes, the Strimzi way! (Part 3)"/>
<meta name="twitter:description" content="Welcome to part three of this blog series!"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
	<link rel="stylesheet" type="text/css" href="css/custom.css" />
	<link rel="stylesheet" type="text/css" href="css/dark.css" media="(prefers-color-scheme: dark)" />
	<link rel="stylesheet" type="text/css" href="css/custom-dark.css" media="(prefers-color-scheme: dark)" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<script src="js/main.js"></script>
	<script src="js/abc.js"></script>
	<script src="js/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="">
	<h1 class="site-title"><a href="">Abhishek&#39;s blog (work in progress)</a></h1>
	<div class="site-description"><h2>Mostly about Kafka, Databases, Kubernetes and other open source topics</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/abhirockzz/" title="Github"><i data-feather="github"></i></a><a href="https://twitter.com/abhi_tweeter" title="Twitter"><i data-feather="twitter"></i></a><a href="https://www.linkedin.com/in/abhirockzz/" title="LinkedIn"><i data-feather="linkedin"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/books">Books</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Kafka on Kubernetes, the Strimzi way! (Part 3)</h1>
			<div class="meta">Posted at &mdash; Jul 7, 2020</div>
		</div>

		<div class="markdown">
			<p>Over the course of the first two parts of this blog series, we setup a single-node Kafka cluster on Kubernetes, secured it using TLS encryption and accessed the broker using both internal and external clients. Let&rsquo;s keep iterating! In this post, we will continue the Kafka on Kubernetes journey with Strimzi and cover:</p>
<ul>
<li>How to apply different authentication types: <code>TLS</code> and <code>SASL SCRAM-SHA-512</code></li>
<li>Use Strimzi Entity operator to manage Kafka users and topics</li>
<li>How to configure Kafka CLI and Go client applications to securely connect to the Kafka cluster</li>
</ul>
<blockquote>
<p>The code is available on GitHub - <a href="https://github.com/abhirockzz/kafka-kubernetes-strimzi/">https://github.com/abhirockzz/kafka-kubernetes-strimzi/</a></p>
</blockquote>
<h2 id="what-do-i-need-to-go-through-this-tutorial">What do I need to go through this tutorial?</h2>
<p><code>kubectl</code> - <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></p>
<p>I will be using <a href="https://docs.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=devto-blog-abhishgu">Azure Kubernetes Service (AKS)</a> to demonstrate the concepts, but by and large it is independent of the Kubernetes provider (e.g. feel free to use a local setup such as <code>minikube</code>). If you want to use <code>AKS</code>, all you need is a <a href="https://docs.microsoft.com/azure/?WT.mc_id=devto-blog-abhishgu">Microsoft Azure account</a> which you can <a href="https://azure.microsoft.com/free/?WT.mc_id=devto-blog-abhishgu">get for FREE</a> if you don&rsquo;t have one already.</p>
<blockquote>
<p>I will not be repeating some of the common sections (such as Installation/Setup (Helm, Strimzi, Azure Kubernetes Service), Strimzi overview) in this or subsequent part of this series and would request you to <a href="https://dev.to/azure/kafka-on-kubernetes-the-strimzi-way-part-1-57g7">refer to part one</a></p>
</blockquote>
<h2 id="create-a-kafka-cluster-with-tls-authentication">Create a Kafka cluster with TLS authentication</h2>
<p>To enforce 2-way mutual <code>TLS</code> auth, all we need to do is tweak the Strimzi <code>Kafka</code> resource. I am highlighting the key part below. The other parts remain the same (<a href="https://github.com/abhirockzz/kafka-kubernetes-strimzi/raw/master/part-2/kafka.yaml">here is the manifest from part 2</a>) i.e. single node Kafka and Zookeeper, ephemeral storage along with <code>TLS</code> encryption</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">      <span style="color:#268bd2">external</span>:
        <span style="color:#268bd2">type</span>: loadbalancer
        <span style="color:#268bd2">tls</span>: <span style="color:#cb4b16">true</span>
        <span style="color:#268bd2">authentication</span>:
          <span style="color:#268bd2">type</span>: tls
</code></pre></div><p>All we did is all the <code>tls</code> authentication type as a property of the <code>external</code> listener. In addition to this, we also include the <code>entityOperator</code> configuration as such:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  <span style="color:#268bd2">entityOperator</span>:
    <span style="color:#268bd2">userOperator</span>: {}
    <span style="color:#268bd2">topicOperator</span>: {}
</code></pre></div><p>This activates the Strimzi <code>Entity Operator</code> which in turn comprises of the <code>Topic Operator</code> and <code>User Operator</code>. Just as the <code>Kafka</code> CRD allows you to control Kafka clusters on Kubernetes, a Topic Operator allows you to manage topics in a Kafka cluster through a custom resource called <code>KafkaTopic</code> i.e. you can create, delete and update topics in your Kafka cluster.</p>
<blockquote>
<p>The interesting part is that it&rsquo;s a two-way sync i.e. you can still create topics by accessing the Kafka cluster directly and it would reflect in the <code>KafkaTopic</code> resources being created/updated/deleted</p>
</blockquote>
<p>The goal of the User Operator is to make Kafka user management easier with help of a <code>KafkaUser</code> CRD. All you do is create instances of <code>KafkaUser</code> CRDs and Strimzi takes care of the Kafka specific user management parts</p>
<blockquote>
<p>Unlike Topic Operator, this is not a two-way sync</p>
</blockquote>
<p>Read more about Entity Operator here <a href="https://strimzi.io/docs/operators/master/using.html#assembly-kafka-entity-operator-deployment-configuration-kafka">https://strimzi.io/docs/operators/master/using.html#assembly-kafka-entity-operator-deployment-configuration-kafka</a></p>
<p>We will dive into the practical bit of these two operators in upcoming sections.</p>
<p>To create the Kafka cluster:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/kafka-tls-auth.yaml
</code></pre></div><p><strong>What did the Strimzi Operator do for us in this case?</strong></p>
<p>We covered most of these in <a href="https://dev.to/azure/kafka-on-kubernetes-the-strimzi-way-part-1-57g7">part 1</a> - <code>StatefulSet</code> (and <code>Pods</code>), <code>LoadBalancer</code> Service, <code>ConfigMap</code>, <code>Secret</code> etc. How is the <code>TLS</code> auth config enforced? To figure that out, let&rsquo;s introspect the Kafka server configuration</p>
<blockquote>
<p>As explained in part 1, this is stored in a <code>ConfigMap</code></p>
</blockquote>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">CLUSTER_NAME</span><span style="color:#719e07">=</span>my-kafka-cluster
kubectl get configmap/<span style="color:#2aa198">${</span><span style="color:#268bd2">CLUSTER_NAME</span><span style="color:#2aa198">}</span>-kafka-config -o yaml
</code></pre></div><p>Look at the <code>External listener</code> section in <code>server.config</code>:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    listener.name.external-9094.ssl.client.auth<span style="color:#719e07">=</span>required
    listener.name.external-9094.ssl.truststore.location<span style="color:#719e07">=</span>/tmp/kafka/clients.truststore.p12
    listener.name.external-9094.ssl.truststore.password<span style="color:#719e07">=</span><span style="color:#2aa198">${</span><span style="color:#268bd2">CERTS_STORE_PASSWORD</span><span style="color:#2aa198">}</span>
    listener.name.external-9094.ssl.truststore.type<span style="color:#719e07">=</span>PKCS12
</code></pre></div><p>The snippet highlighted above is the part which was added - notice <code>listener.name.external-9094.ssl.client.auth=required</code> was added along with the truststore details.</p>
<p><strong>Let&rsquo;s not forget the Entity Operator</strong></p>
<p>The Entity Operator runs a separate <code>Deployment</code></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">CLUSTER_NAME</span><span style="color:#719e07">=</span>my-kafka-cluster
kubectl get deployment <span style="color:#268bd2">$CLUSTER_NAME</span>-entity-operator
kubectl get pod -l<span style="color:#719e07">=</span>app.kubernetes.io/name<span style="color:#719e07">=</span>entity-operator

NAME                                                READY   STATUS     
my-kafka-cluster-entity-operator-666f8758f6-gj54h   3/3     Running         
</code></pre></div><p>The entity operator <code>Pod</code> runs three containers - topic-operator, user-operator, tls-sidecar</p>
<p>We have configured our cluster to authenticate client connections, but what about the user credentials which will be used by client apps?</p>
<h2 id="time-to-use-the-user-operator">Time to use the User Operator!</h2>
<p>The User Operator allows us to create <code>KafkaUser</code>s to represent client authentication credentials. As mentioned in the beginning of the blog post, supported authentication types include <code>TLS</code> and <code>SCRAM-SHA-512</code>. Behind the scenes, a Kubernetes <code>Secret</code> is created by Strimzi to store the credentials</p>
<blockquote>
<p>OAuth 2.0 is also supported but its not handled by the User Operator</p>
</blockquote>
<p>Let&rsquo;s create a <code>KafkaUser</code> to store client credentials for TLS auth. Here is what the user info looks like:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#268bd2">apiVersion</span>: kafka.strimzi.io/v1beta1
<span style="color:#268bd2">kind</span>: KafkaUser
<span style="color:#268bd2">metadata</span>:
  <span style="color:#268bd2">name</span>: kafka-tls-client-credentials
  <span style="color:#268bd2">labels</span>:
    <span style="color:#268bd2">strimzi.io/cluster</span>: my-kafka-cluster
<span style="color:#268bd2">spec</span>:
  <span style="color:#268bd2">authentication</span>:
    <span style="color:#268bd2">type</span>: tls
</code></pre></div><p>We name the user <code>kafka-tls-client-credentials</code>, associate with the Kafka cluster we created earlier (using the label <code>strimzi.io/cluster: my-kafka-cluster</code>) and specify the <code>tls</code> authentication type</p>
<blockquote>
<p>You can also define authorization rules (not covered in this blog) within a <code>KafkaUser</code> definition - see <a href="https://strimzi.io/docs/operators/master/using.html#type-KafkaUser-reference">https://strimzi.io/docs/operators/master/using.html#type-KafkaUser-reference</a></p>
</blockquote>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/user-tls-auth.yaml
</code></pre></div><p>Introspect the <code>Secret</code> (it has the same name as the <code>KafkaUser</code>):</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get secret/kafka-tls-client-credentials -o yaml
</code></pre></div><h2 id="tls-client-authentication">TLS client authentication</h2>
<p>That&rsquo;s it! Now its up to the client to use the credentials. We will use a Kafka CLI and Go client application to try this out. First things first:</p>
<p><strong>Extract and configure the user credentials</strong></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">KAFKA_USER_NAME</span><span style="color:#719e07">=</span>kafka-tls-client-credentials
kubectl get secret <span style="color:#268bd2">$KAFKA_USER_NAME</span> -o <span style="color:#268bd2">jsonpath</span><span style="color:#719e07">=</span><span style="color:#2aa198">&#39;{.data.user\.crt}&#39;</span> | base64 --decode &gt; user.crt
kubectl get secret <span style="color:#268bd2">$KAFKA_USER_NAME</span> -o <span style="color:#268bd2">jsonpath</span><span style="color:#719e07">=</span><span style="color:#2aa198">&#39;{.data.user\.key}&#39;</span> | base64 --decode &gt; user.key
kubectl get secret <span style="color:#268bd2">$KAFKA_USER_NAME</span> -o <span style="color:#268bd2">jsonpath</span><span style="color:#719e07">=</span><span style="color:#2aa198">&#39;{.data.user\.p12}&#39;</span> | base64 --decode &gt; user.p12
kubectl get secret <span style="color:#268bd2">$KAFKA_USER_NAME</span> -o <span style="color:#268bd2">jsonpath</span><span style="color:#719e07">=</span><span style="color:#2aa198">&#39;{.data.user\.password}&#39;</span> | base64 --decode &gt; user.password
</code></pre></div><p>Import the entry in <code>user.p12</code> into another keystore</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">USER_P12_FILE_PATH</span><span style="color:#719e07">=</span>user.p12
<span style="color:#b58900">export</span> <span style="color:#268bd2">USER_KEY_PASSWORD_FILE_PATH</span><span style="color:#719e07">=</span>user.password
<span style="color:#b58900">export</span> <span style="color:#268bd2">KEYSTORE_NAME</span><span style="color:#719e07">=</span>kafka-auth-keystore.jks
<span style="color:#b58900">export</span> <span style="color:#268bd2">KEYSTORE_PASSWORD</span><span style="color:#719e07">=</span>foobar
<span style="color:#b58900">export</span> <span style="color:#268bd2">PASSWORD</span><span style="color:#719e07">=</span><span style="color:#586e75">`</span>cat <span style="color:#268bd2">$USER_KEY_PASSWORD_FILE_PATH</span><span style="color:#586e75">`</span>

sudo keytool -importkeystore -deststorepass <span style="color:#268bd2">$KEYSTORE_PASSWORD</span> -destkeystore <span style="color:#268bd2">$KEYSTORE_NAME</span> -srckeystore <span style="color:#268bd2">$USER_P12_FILE_PATH</span> -srcstorepass <span style="color:#268bd2">$PASSWORD</span> -srcstoretype PKCS12

sudo keytool -list -alias <span style="color:#268bd2">$KAFKA_USER_NAME</span> -keystore <span style="color:#268bd2">$KEYSTORE_NAME</span>
</code></pre></div><p>Just like we did in <a href="https://dev.to/azure/kafka-on-kubernetes-the-strimzi-way-part-2-1210">part 2</a>, TLS encryption config requires importing the cluster CA cert in the client truststore</p>
<p><strong>Extract and configure server CA cert</strong></p>
<p>Extract the cluster CA certificate and password</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">CLUSTER_NAME</span><span style="color:#719e07">=</span>my-kafka-cluster

kubectl get secret <span style="color:#268bd2">$CLUSTER_NAME</span>-cluster-ca-cert -o <span style="color:#268bd2">jsonpath</span><span style="color:#719e07">=</span><span style="color:#2aa198">&#39;{.data.ca\.crt}&#39;</span> | base64 --decode &gt; ca.crt
kubectl get secret <span style="color:#268bd2">$CLUSTER_NAME</span>-cluster-ca-cert -o <span style="color:#268bd2">jsonpath</span><span style="color:#719e07">=</span><span style="color:#2aa198">&#39;{.data.ca\.password}&#39;</span> | base64 --decode &gt; ca.password
</code></pre></div><p>Import it into <code>truststore</code> - I am using the built-in truststore which comes in with a JDK (Java) installation - but this is just for convenience and you&rsquo;re free to use other truststore</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">CERT_FILE_PATH</span><span style="color:#719e07">=</span>ca.crt
<span style="color:#b58900">export</span> <span style="color:#268bd2">CERT_PASSWORD_FILE_PATH</span><span style="color:#719e07">=</span>ca.password

<span style="color:#586e75"># replace this with the path to your truststore</span>

<span style="color:#b58900">export</span> <span style="color:#268bd2">KEYSTORE_LOCATION</span><span style="color:#719e07">=</span>/Library/Java/JavaVirtualMachines/jdk1.8.0_221.jdk/Contents/Home/jre/lib/security/cacerts
<span style="color:#b58900">export</span> <span style="color:#268bd2">PASSWORD</span><span style="color:#719e07">=</span><span style="color:#586e75">`</span>cat <span style="color:#268bd2">$CERT_PASSWORD_FILE_PATH</span><span style="color:#586e75">`</span>

<span style="color:#586e75"># you will prompted for the truststore password. for JDK truststore, the default password is &#34;changeit&#34;</span>
<span style="color:#586e75"># Type yes in response to the &#39;Trust this certificate? [no]:&#39; prompt</span>

sudo keytool -importcert -alias strimzi-kafka-cert -file <span style="color:#268bd2">$CERT_FILE_PATH</span> -keystore <span style="color:#268bd2">$KEYSTORE_LOCATION</span> -keypass <span style="color:#268bd2">$PASSWORD</span>

sudo keytool -list -alias strimzi-kafka-cert -keystore <span style="color:#268bd2">$KEYSTORE_LOCATION</span>
</code></pre></div><p>You should now be able to authenticate to the Kafka cluster using the Kafka CLI client</p>
<blockquote>
<p>Please note that the configuration steps for the Kafka CLI as detailed below will also work for the Java clients as well - feel free to try that out as well</p>
</blockquote>
<p><strong>Create properties file for Kafka CLI clients</strong></p>
<p>Extract the <code>LoadBalancer</code> public IP for Kafka cluster</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">KAFKA_CLUSTER_NAME</span><span style="color:#719e07">=</span>my-kafka-cluster

kubectl get service/<span style="color:#2aa198">${</span><span style="color:#268bd2">KAFKA_CLUSTER_NAME</span><span style="color:#2aa198">}</span>-kafka-external-bootstrap --output<span style="color:#719e07">=</span><span style="color:#268bd2">jsonpath</span><span style="color:#719e07">={</span>.status.loadBalancer.ingress<span style="color:#719e07">[</span>0<span style="color:#719e07">]</span>.ip<span style="color:#719e07">}</span>
</code></pre></div><p>Create a file called <code>client-ssl-auth.properties</code> with the following contents:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bootstrap.servers<span style="color:#719e07">=[</span>LOADBALANCER_PUBLIC_IP<span style="color:#719e07">]</span>:9094
security.protocol<span style="color:#719e07">=</span>SSL
ssl.truststore.location<span style="color:#719e07">=[</span>TRUSTSTORE_LOCATION<span style="color:#719e07">]</span>
ssl.truststore.password<span style="color:#719e07">=</span>changeit
ssl.keystore.location<span style="color:#719e07">=</span>kafka-auth-keystore.jks
ssl.keystore.password<span style="color:#719e07">=</span>foobar
ssl.key.password<span style="color:#719e07">=[</span>contents of user.password file<span style="color:#719e07">]</span>
</code></pre></div><blockquote>
<p><code>changeit</code> is the default truststore password. Please use a different one if needed</p>
</blockquote>
<p>Download Kafka if you don&rsquo;t have it already - <a href="https://kafka.apache.org/downloads">https://kafka.apache.org/downloads</a></p>
<p>One last thing before you proceed</p>
<p><strong>Create a <code>KafkaTopic</code></strong></p>
<p>As I mentioned earlier, the Topic Operator makes this possible to embed topic info in form of a <code>KafkaTopic</code> manifest as such:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#268bd2">apiVersion</span>: kafka.strimzi.io/v1beta1
<span style="color:#268bd2">kind</span>: KafkaTopic
<span style="color:#268bd2">metadata</span>:
  <span style="color:#268bd2">name</span>: strimzi-test-topic
  <span style="color:#268bd2">labels</span>:
    <span style="color:#268bd2">strimzi.io/cluster</span>: my-kafka-cluster
<span style="color:#268bd2">spec</span>:
  <span style="color:#268bd2">partitions</span>: <span style="color:#2aa198">3</span>
  <span style="color:#268bd2">replicas</span>: <span style="color:#2aa198">1</span>
</code></pre></div><p>To create the topic:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/topic.yaml
</code></pre></div><blockquote>
<p>Here is the reference for a <code>KafkaTopic</code> CRD <a href="https://strimzi.io/docs/operators/master/using.html#type-KafkaTopic-reference">https://strimzi.io/docs/operators/master/using.html#type-KafkaTopic-reference</a></p>
</blockquote>
<p>All you need to do is use the <code>kafka-console-producer</code> and <code>kafka-console-consumer</code> by pointing it to the <code>client-ssl-auth.properties</code> file you just created</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">KAFKA_HOME</span><span style="color:#719e07">=[</span>replace with kafka installation<span style="color:#719e07">]</span> e.g. /Users/foobar/kafka_2.12-2.3.0
<span style="color:#b58900">export</span> <span style="color:#268bd2">LOADBALANCER_PUBLIC_IP</span><span style="color:#719e07">=[</span>replace with public-ip<span style="color:#719e07">]</span>
<span style="color:#b58900">export</span> <span style="color:#268bd2">TOPIC_NAME</span><span style="color:#719e07">=</span>strimzi-test-topic

<span style="color:#586e75"># on a terminal, start producer and send a few messages</span>
<span style="color:#268bd2">$KAFKA_HOME</span>/bin/kafka-console-producer.sh --broker-list <span style="color:#268bd2">$LOADBALANCER_PUBLIC_IP</span>:9094 --topic <span style="color:#268bd2">$TOPIC_NAME</span> --producer.config client-ssl-auth.properties

<span style="color:#586e75"># on another terminal, start consumer</span>
<span style="color:#268bd2">$KAFKA_HOME</span>/bin/kafka-console-consumer.sh --bootstrap-server <span style="color:#268bd2">$LOADBALANCER_PUBLIC_IP</span>:9094 --topic <span style="color:#268bd2">$TOPIC_NAME</span> --consumer.config client-ssl-auth.properties --from-beginning
</code></pre></div><p>You should see producer and consumer working in tandem. Great!</p>
<blockquote>
<p>If you face SSL Handshake errors, please check whether keys and certificates has been correctly imported and you&rsquo;re using the correct password. If the Kafka cluster is not reachable, ensure you are using the right value for the public IP</p>
</blockquote>
<p>Now, let&rsquo;s try a programmatic client. Since the Java client behavior (required config properties) are same as the CLI, I am using a Go client to try something different. Don&rsquo;t worry, if you are not a Go programmer, it should be easy to follow along.</p>
<p>I will not walk through the entire program, just the part where we create the connection related configuration. Here is the snippet:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    bootstrapServers = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;KAFKA_BOOTSTRAP_SERVERS&#34;</span>)
    caLocation = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;CA_CERT_LOCATION&#34;</span>)
    topic = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;KAFKA_TOPIC&#34;</span>)

    userCertLocation = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;USER_CERT_LOCATION&#34;</span>)
    userKeyLocation = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;USER_KEY_LOCATION&#34;</span>)
    userKeyPassword = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;USER_KEY_PASSWORD&#34;</span>)

    producerConfig <span style="color:#719e07">:=</span> <span style="color:#719e07">&amp;</span>kafka.ConfigMap{<span style="color:#2aa198">&#34;bootstrap.servers&#34;</span>: bootstrapServers, <span style="color:#2aa198">&#34;security.protocol&#34;</span>: <span style="color:#2aa198">&#34;SSL&#34;</span>, <span style="color:#2aa198">&#34;ssl.ca.location&#34;</span>: caLocation, <span style="color:#2aa198">&#34;ssl.certificate.location&#34;</span>: userCertLocation, <span style="color:#2aa198">&#34;ssl.key.location&#34;</span>: userKeyLocation, <span style="color:#2aa198">&#34;ssl.key.password&#34;</span>: userKeyPassword}
</code></pre></div><p>Notice that the <code>bootstrap.servers</code> and <code>security.protocol</code> are the same as ones you used in the Kafka CLI client (same for Java as well).</p>
<ul>
<li>For TLS encryption: <code>ssl.ca.location</code> is used to point to the CA certificate directly as opposed to a truststore</li>
<li>For client authentication: <code>ssl.certificate.location</code>, <code>ssl.key.location</code> and <code>ssl.key.password</code> refer to the user certificate, user key and password respectively</li>
</ul>
<p>If you have <code>Go</code> installed, you can try it out. Clone the Git repo</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone https://github.com/abhirockzz/kafka-kubernetes-strimzi
<span style="color:#b58900">cd</span> part-3/go-client-app
</code></pre></div><p>.. and run the program:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">export KAFKA_BOOTSTRAP_SERVERS=[replace with public<span style="color:#719e07">-</span>ip:<span style="color:#2aa198">9094</span>] e.g. <span style="color:#2aa198">20.43.176.7</span>:<span style="color:#2aa198">9094</span>
export CA_CERT_LOCATION=[replace with location of ca.crt file] e.g. <span style="color:#719e07">/</span>Users<span style="color:#719e07">/</span>code<span style="color:#719e07">/</span>kafka<span style="color:#719e07">-</span>kubernetes<span style="color:#719e07">-</span>strimzi<span style="color:#719e07">/</span>part<span style="color:#719e07">-</span><span style="color:#2aa198">3</span><span style="color:#719e07">/</span>ca.crt
export KAFKA_TOPIC=test<span style="color:#719e07">-</span>strimzi<span style="color:#719e07">-</span>topic

export USER_CERT_LOCATION=[path to user.crt file] e.g. <span style="color:#719e07">/</span>Users<span style="color:#719e07">/</span>code<span style="color:#719e07">/</span>kafka<span style="color:#719e07">-</span>kubernetes<span style="color:#719e07">-</span>strimzi<span style="color:#719e07">/</span>part<span style="color:#719e07">-</span><span style="color:#2aa198">3</span><span style="color:#719e07">/</span>user.crt
export USER_KEY_LOCATION=[path to user.key file] e.g. <span style="color:#719e07">/</span>Users<span style="color:#719e07">/</span>code<span style="color:#719e07">/</span>kafka<span style="color:#719e07">-</span>kubernetes<span style="color:#719e07">-</span>strimzi<span style="color:#719e07">/</span>part<span style="color:#719e07">-</span><span style="color:#2aa198">3</span><span style="color:#719e07">/</span>user.key
export USER_KEY_PASSWORD=[contents of user.password file]

<span style="color:#719e07">go</span> run kafka<span style="color:#719e07">-</span>tls<span style="color:#719e07">-</span>auth<span style="color:#719e07">-</span>client.<span style="color:#719e07">go</span>
</code></pre></div><p>The logs should confirm whether messages are being produced and consumed</p>
<h2 id="enforce-scram-sha-512-auth">Enforce SCRAM-SHA-512 auth</h2>
<p><code>SCRAM</code> stands for &ldquo;Salted Challenge Response Authentication Mechanism&rdquo;. I will not pretend to be a security or <code>SCRAM</code> expert, but do want to highlight that it is one of the supported and commonly used authentication mechanism in Kafka (in addition to other such as <code>PLAIN</code>)</p>
<blockquote>
<p>Please note that Strimzi does not support <code>SASL PLAIN</code> auth at the time of writing</p>
</blockquote>
<p><strong>Update the Kafka cluster</strong></p>
<p>To apply the <code>SCRAM</code> authentication scheme - all you need is to set the <code>authentication.type</code> to <code>scram-sha-512</code></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">      <span style="color:#268bd2">external</span>:
        <span style="color:#268bd2">type</span>: loadbalancer
        <span style="color:#268bd2">tls</span>: <span style="color:#cb4b16">true</span>
        <span style="color:#268bd2">authentication</span>:
          <span style="color:#268bd2">type</span>: scram-sha-512
</code></pre></div><p>Update the Kafka cluster to use <code>SCRAM-SHA</code> authentication</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/kafka-tls-auth.yaml
</code></pre></div><p>Let&rsquo;s take a look at how the Kafka server config looks like in this case:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">CLUSTER_NAME</span><span style="color:#719e07">=</span>my-kafka-cluster
kubectl get configmap/<span style="color:#2aa198">${</span><span style="color:#268bd2">CLUSTER_NAME</span><span style="color:#2aa198">}</span>-kafka-config -o yaml
</code></pre></div><p>Introspect <code>External listener</code> section in <code>server.config</code> and notice how the the config has been updated to reflect</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    listener.name.external-9094.scram-sha-512.sasl.jaas.config<span style="color:#719e07">=</span>org.apache.kafka.common.security.scram.ScramLoginModule required;
    listener.name.external-9094.sasl.enabled.mechanisms<span style="color:#719e07">=</span>SCRAM-SHA-512
</code></pre></div><p><strong>Create SCRAM credentials (<code>KafkaUser</code>)</strong></p>
<p>Just like we did with <code>TLS</code> auth, we need to create client credentials for <code>SCRAM</code> as well. It only differs from its TLS equivalent in terms of name and the type (of course!)</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#268bd2">apiVersion</span>: kafka.strimzi.io/v1beta1
<span style="color:#268bd2">kind</span>: KafkaUser
<span style="color:#268bd2">metadata</span>:
  <span style="color:#268bd2">name</span>: kafka-scram-client-credentials
  <span style="color:#268bd2">labels</span>:
    <span style="color:#268bd2">strimzi.io/cluster</span>: my-kafka-cluster
<span style="color:#268bd2">spec</span>:
  <span style="color:#268bd2">authentication</span>:
    <span style="color:#268bd2">type</span>: scram-sha-512
</code></pre></div><blockquote>
<p>notice that <code>authentication.type</code> is <code>scram-sha-512</code></p>
</blockquote>
<p>Create the <code>KafkaUser</code></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f https://raw.githubusercontent.com/abhirockzz/kafka-kubernetes-strimzi/master/part-3/user-scram-auth.yaml
</code></pre></div><p>Introspect the <code>Secret</code> (it has the same name as the <code>KafkaUser</code>):</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get secret/kafka-scram-client-credentials -o yaml
</code></pre></div><p>The <code>Secret</code> contains the <code>password</code> in <code>base64</code> encoded form</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#268bd2">apiVersion</span>: v1
<span style="color:#268bd2">kind</span>: Secret
<span style="color:#268bd2">name</span>: kafka-scram-client-credentials
<span style="color:#268bd2">data</span>:
  <span style="color:#268bd2">password</span>: SnpteEQwek1DNkdi
...
</code></pre></div><blockquote>
<p>Username is same as the <code>KafkaUser</code>/<code>Secret</code> name, which is <code>kafka-scram-client-credentials</code> in this example</p>
</blockquote>
<p><strong>Run client applications</strong></p>
<p>In order run the client examples, download the the password:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">USER_NAME</span><span style="color:#719e07">=</span>kafka-scram-client-credentials
kubectl get secret <span style="color:#268bd2">$USER_NAME</span> -o <span style="color:#268bd2">jsonpath</span><span style="color:#719e07">=</span><span style="color:#2aa198">&#39;{.data.password}&#39;</span> | base64 --decode &gt; user-scram.password
</code></pre></div><p>To test the Kafka CLI client, create a file <code>client-scram-auth.properties</code> with the following contents:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bootstrap.servers<span style="color:#719e07">=[</span>replace with public-ip:9094<span style="color:#719e07">]</span>
security.protocol<span style="color:#719e07">=</span>SASL_SSL
sasl.mechanism<span style="color:#719e07">=</span>SCRAM-SHA-512
ssl.truststore.location<span style="color:#719e07">=[</span>replace with path to truststore with kafka CA cert<span style="color:#719e07">]</span>
<span style="color:#586e75"># &#34;changeit&#34; is the default password for JDK truststore, please use the one applicable to yours</span>
ssl.truststore.password<span style="color:#719e07">=</span>changeit
sasl.jaas.config<span style="color:#719e07">=</span>org.apache.kafka.common.security.scram.ScramLoginModule required <span style="color:#268bd2">username</span><span style="color:#719e07">=</span><span style="color:#2aa198">&#34;kafka-scram-client-credentials&#34;</span> <span style="color:#268bd2">password</span><span style="color:#719e07">=</span><span style="color:#2aa198">&#34;[replace with contents of user-scram.password file]&#34;</span>;
</code></pre></div><p>Refer to the instructions above to run the console producer and consumer</p>
<blockquote>
<p>please make sure you use the <code>client-scram-auth.properties</code> and not the <code>client-tls-auth.properties</code> file</p>
</blockquote>
<p>Before wrapping up, lets look at the Go client and see how it handles <code>SCRAM</code> authentication. As always, I will only highlight the part which showcases the configuration:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    bootstrapServers = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;KAFKA_BOOTSTRAP_SERVERS&#34;</span>)
    caLocation = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;CA_CERT_LOCATION&#34;</span>)
    topic = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;KAFKA_TOPIC&#34;</span>)

    kafkaScramUsername = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;SCRAM_USERNAME&#34;</span>)
    kafkaScramPassword = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;SCRAM_PASSWORD&#34;</span>)

    producerConfig <span style="color:#719e07">:=</span> <span style="color:#719e07">&amp;</span>kafka.ConfigMap{<span style="color:#2aa198">&#34;bootstrap.servers&#34;</span>: bootstrapServers, <span style="color:#2aa198">&#34;security.protocol&#34;</span>: <span style="color:#2aa198">&#34;SASL_SSL&#34;</span>, <span style="color:#2aa198">&#34;ssl.ca.location&#34;</span>: caLocation, <span style="color:#2aa198">&#34;sasl.mechanism&#34;</span>: <span style="color:#2aa198">&#34;SCRAM-SHA-512&#34;</span>, <span style="color:#2aa198">&#34;sasl.username&#34;</span>: kafkaScramUsername, <span style="color:#2aa198">&#34;sasl.password&#34;</span>: kafkaScramPassword}
</code></pre></div><p>The <code>security.protocol</code> and <code>sasl.mechanism</code> have been updated to <code>SASL_SSL</code> and <code>SCRAM-SHA-512</code> respectively. Along with that, we use the <code>sasl.username</code> and <code>sasl.password</code> to specify the client credentials</p>
<p>To run the <code>Go</code> client app:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">KAFKA_BOOTSTRAP_SERVERS</span><span style="color:#719e07">=[</span>replace with public-ip:9094<span style="color:#719e07">]</span>
<span style="color:#b58900">export</span> <span style="color:#268bd2">CA_CERT_LOCATION</span><span style="color:#719e07">=[</span>path to ca.crt file<span style="color:#719e07">]</span> f.g. /Users/code/kafka-kubernetes-strimzi/part-3/ca.crt
<span style="color:#b58900">export</span> <span style="color:#268bd2">KAFKA_TOPIC</span><span style="color:#719e07">=</span>strimzi-test-topic

<span style="color:#b58900">export</span> <span style="color:#268bd2">SCRAM_USERNAME</span><span style="color:#719e07">=</span>kafka-scram-client-credentials
<span style="color:#b58900">export</span> <span style="color:#268bd2">SCRAM_PASSWORD</span><span style="color:#719e07">=[</span>contents of user-scram.password file<span style="color:#719e07">]</span>

go run kafka-scram-auth-client.go
</code></pre></div><h2 id="wrap-up-for-now">Wrap up.. for now</h2>
<p>This post covered a decent amount of ground! We learnt how to apply different authentication types, use Entity Operators to manage Kafka users and topics and more importantly, understand how client applications need to configured to connect securely using a combination of TLS encryption and the chosen authentication scheme.</p>
<p>We&rsquo;re far from done! All this while, we&rsquo;ve been creating <code>ephemeral</code> clusters with no persistence - we will fix that in upcoming posts.</p>

		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/kafka">kafka</a></li>
								
								<li><a href="/tags/kubernetes">kubernetes</a></li>
								
								<li><a href="/tags/strimzi">strimzi</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © Copyright notice |  <a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-54762029-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script>feather.replace()</script>
</body>
</html>
