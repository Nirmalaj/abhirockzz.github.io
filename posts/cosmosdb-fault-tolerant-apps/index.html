<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Build fault tolerant applications with Cassandra API for Azure Cosmos DB - Foo Bar Baz</title>
  <meta name="description" content="Azure Cosmos DB is a resource governed system that allows you to execute a certain number of operations per second based on the provisioned throughput you have configured.">
  <meta name="author" content="Abhishek Gupta"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Foo Bar Baz",
    
    "url": "https:\/\/abhirockzz.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/abhirockzz.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/abhirockzz.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/abhirockzz.github.io\/posts\/cosmosdb-fault-tolerant-apps\/",
          "name": "Build fault tolerant applications with cassandra a p i for azure cosmos d b"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Abhishek Gupta"
  },
  "headline": "Build fault tolerant applications with Cassandra API for Azure Cosmos DB",
  "description" : "Azure Cosmos DB is a resource governed system that allows you to execute a certain number of operations per second based on the provisioned throughput you have configured.",
  "inLanguage" : "en",
  "wordCount":  1729 ,
  "datePublished" : "2020-09-10T00:00:00",
  "dateModified" : "2020-09-10T00:00:00",
  "image" : "https:\/\/abhirockzz.github.io\/icon.jpg",
  "keywords" : [ "" ],
  "mainEntityOfPage" : "https:\/\/abhirockzz.github.io\/posts\/cosmosdb-fault-tolerant-apps\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/abhirockzz.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/abhirockzz.github.io\/icon.jpg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Build fault tolerant applications with Cassandra API for Azure Cosmos DB" />
<meta property="og:description" content="Azure Cosmos DB is a resource governed system that allows you to execute a certain number of operations per second based on the provisioned throughput you have configured.">
<meta property="og:image" content="https://abhirockzz.github.io/icon.jpg" />
<meta property="og:url" content="https://abhirockzz.github.io/posts/cosmosdb-fault-tolerant-apps/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Foo Bar Baz" />

  <meta name="twitter:title" content="Build fault tolerant applications with Cassandra API for Azure Cosmos …" />
  <meta name="twitter:description" content="Azure Cosmos DB is a resource governed system that allows you to execute a certain number of operations per second based on the provisioned throughput you have configured.">
  <meta name="twitter:image" content="https://abhirockzz.github.io/icon.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@abhi_tweeter" />
  <meta name="twitter:creator" content="@abhi_tweeter" />
  <link href='https://abhirockzz.github.io/icons/myicon.png' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.80.0" />
  <link rel="alternate" href="https://abhirockzz.github.io/index.xml" type="application/rss+xml" title="Foo Bar Baz"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://abhirockzz.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://abhirockzz.github.io/css/syntax.css" /><link rel="stylesheet" href="https://abhirockzz.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-54762029-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://abhirockzz.github.io/">Foo Bar Baz</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Home" href="/">Home</a>
            </li>
          
        
          
            <li>
              <a title="All posts" href="/posts">All posts</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/about">About</a>
            </li>
          
        
          
            <li>
              <a title="Books" href="/books">Books</a>
            </li>
          
        
          
            <li>
              <a title="Presentations" href="/presentations">Presentations</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Foo Bar Baz" href="https://abhirockzz.github.io/">
            <img class="avatar-img" src="https://abhirockzz.github.io/icon.jpg" alt="Foo Bar Baz" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="posts-heading">
              
                <h1>Build fault tolerant applications with Cassandra API for Azure Cosmos DB</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p><a href="http://www.azurecosmosdb.com/">Azure Cosmos DB</a> is a resource governed system that allows you to execute a certain number of operations per second based on the <a href="https://docs.microsoft.com/azure/cosmos-db/set-throughput">provisioned throughput</a> you have configured. If clients exceed that limit and consume more <a href="https://docs.microsoft.com/azure/cosmos-db/request-units">request units</a> than what was provisioned, it leads to rate limiting of subsequent requests and exceptions being thrown – they are also referred to as <a href="https://docs.microsoft.com/rest/api/cosmos-db/http-status-codes-for-cosmosdb?WT.mc_id=devto-blog-abhishgu">429 errors</a>.</p>
<p>With the help of a practical example, I&rsquo;ll demonstrate how to incorporate fault-tolerance in your <a href="https://golang.org/">Go</a> applications by handling and retrying operations affected by these rate limiting errors. To help you follow along, the sample application code for this blog is available <a href="https://github.com/abhirockzz/cosmos-go-rate-limiting">on GitHub</a> - it uses the <a href="https://github.com/gocql/gocql">gocql driver for Apache Cassandra</a>.</p>
<p>In this post, we&rsquo;ll go through:</p>
<ul>
<li>Initial setup and configuration before running the sample application</li>
<li>Execution of various load test scenarios and analyze the results</li>
<li>A quick overview of the Retry Policy implementation.</li>
</ul>
<p>One way of tackling rate limiting is by adjusting provisioned throughput to meet your application requirements. There are <a href="https://docs.microsoft.com/azure/cosmos-db/manage-scale-cassandra?WT.mc_id=devto-blog-abhishgu#manage-scaling">multiple ways to do this</a>, including using Azure portal, Azure CLI, and CQL (Cassandra Query Language) commands.</p>
<p><strong>But, what if you wanted to handle these errors in the application itself?</strong></p>
<p>The good thing is that the Cassandra API for Azure Cosmos DB translates the rate limiting exceptions into overloaded errors on the Cassandra native protocol. Since the <code>gocql</code> driver allows you to plugin your own <a href="https://pkg.go.dev/github.com/gocql/gocql?tab=doc#RetryPolicy">RetryPolicy</a>, you can write a custom implementation to intercept these errors and retry them after a certain (cool down) time period. This policy can then <a href="https://pkg.go.dev/github.com/gocql/gocql?tab=doc#Query.RetryPolicy">be applied to each Query</a> or at a global level using a <a href="https://pkg.go.dev/github.com/gocql/gocql?tab=doc#ClusterConfig">ClusterConfig</a>.</p>
<p>The <a href="https://github.com/Azure/azure-cosmos-cassandra-extensions">Azure Cosmos DB extension</a> library makes it quite easy to use Retry Policies in your Java applications. An equivalent Go version is <a href="https://github.com/abhirockzz/cosmos-cassandra-go-extension">available on GitHub</a> and has been used in the sample application for this blog post.</p>
<h2 id="retry-policy-in-action">Retry Policy in action</h2>
<p>As promised, you will walk through the entire process using a simple yet practical example. The sample application used to demonstrate the concepts is a service that exposes a REST endpoint to <code>POST</code> orders data which is persisted to a Cassandra table in Azure Cosmos DB.</p>
<p>You will run a few load tests on this API service to see how rate limiting manifests itself and how it&rsquo;s handled.</p>
<h3 id="pre-requisites">Pre-requisites</h3>
<p>Start by installing <a href="https://github.com/rakyll/hey">hey</a>, a load testing program. You can download OS specific binaries (64-bit) for <a href="https://storage.googleapis.com/hey-release/hey_linux_amd64">Linux</a>, <a href="https://storage.googleapis.com/hey-release/hey_darwin_amd64">Mac</a> and <a href="https://storage.googleapis.com/hey-release/hey_windows_amd64">Windows</a> (please refer to <a href="https://github.com/rakyll/hey#installation">the GitHub repo</a> for latest information in case you face issues downloading the utility)</p>
<blockquote>
<p>You can use any other tool that allows you to generate load on an HTTP endpoint</p>
</blockquote>
<p>Clone this GitHub repo and change into the right directory:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">git clone github.com/abhirockzz/cosmos-go-rate-limiting 
<span class="nb">cd</span> cosmos-go-rate-limiting
</code></pre></div><h3 id="setup-azure-cosmos-db">Setup Azure Cosmos DB</h3>
<p>Create an Azure <a href="https://docs.microsoft.com/azure/cosmos-db/create-cassandra-api-account-java?WT.mc_id=devto-blog-abhishgu#create-a-database-account">Cosmos DB account</a> with the Cassandra API option selected</p>
<p>To create a Keyspace and Table, use the following <code>CQL</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql">    <span class="k">CREATE</span> <span class="n">KEYSPACE</span> <span class="n">ordersapp</span> <span class="k">WITH</span> <span class="n">REPLICATION</span> <span class="o">=</span> <span class="err">{</span><span class="s1">&#39;class&#39;</span> <span class="p">:</span> <span class="s1">&#39;SimpleStrategy&#39;</span><span class="err">}</span><span class="p">;</span>
    
    <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">ordersapp</span><span class="p">.</span><span class="n">orders</span> <span class="p">(</span>
        <span class="n">id</span> <span class="n">uuid</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
        <span class="n">amount</span> <span class="nb">int</span><span class="p">,</span>
        <span class="k">state</span> <span class="nb">text</span><span class="p">,</span>
        <span class="n">time</span> <span class="k">timestamp</span>
    <span class="p">);</span>
</code></pre></div><h3 id="start-the-application">Start the application</h3>
<p>Open a terminal and set the environment variables for the application:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">COSMOSDB_CASSANDRA_CONTACT_POINT</span><span class="o">=</span>.cassandra.cosmos.azure.com 
<span class="nb">export</span> <span class="nv">COSMOSDB_CASSANDRA_PORT</span><span class="o">=</span><span class="m">10350</span> 
<span class="nb">export</span> <span class="nv">COSMOSDB_CASSANDRA_USER</span><span class="o">=</span> 
<span class="nb">export</span> <span class="nv">COSMOSDB_CASSANDRA_PASSWORD</span><span class="o">=</span> 
<span class="c1">#optional (default: 5) </span>
<span class="c1">#export MAX_RETRIES=</span>
</code></pre></div><p>To start the application:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">go run main.go 
    
//wait <span class="k">for</span> this output 
Connected to Azure Cosmos DB
</code></pre></div><p>To test whether the application is working as expected, insert a few orders by invoking the REST endpoint (once for each order) from a different terminal:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">curl http://localhost:8080/orders
</code></pre></div><p>The application generates random data so you don&rsquo;t have to enter it while invoking the endpoint</p>
<p>Confirm that the order was successfully stored. You can use the <a href="https://docs.microsoft.com/azure/cosmos-db/cassandra-support?WT.mc_id=devto-blog-abhishgu#hosted-cql-shell-preview">hosted CQL shell in the Azure portal</a> and execute the below query:</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">ordersapp</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span>
    
<span class="o">//</span> <span class="n">you</span> <span class="n">should</span> <span class="n">see</span> <span class="n">this</span> <span class="k">output</span>
<span class="k">system</span><span class="p">.</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> 
<span class="c1">----------------- 
</span><span class="c1"></span>        <span class="mi">1</span> 
<span class="p">(</span><span class="mi">1</span> <span class="k">rows</span><span class="p">)</span>
</code></pre></div><p>You&rsquo;re all set.</p>
<h3 id="let-the-load-tests-begin">Let the load tests begin!</h3>
<p>Invoke the REST endpoint with 300 requests. This is enough to overload the system since you only have 400 RU/s allocated by default.</p>
<p>To start the load test:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">hey -t <span class="m">0</span> -n <span class="m">300</span> http://localhost:8080/orders
</code></pre></div><p>Notice the logs in the application terminal. In the beginning, you will see that the orders are being successfully created. For example:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">Added order ID 25a8cec1-e67a-11ea-9c17-7f242c2eeac0
Added order ID 25a8f5ef-e67a-11ea-9c17-7f242c2eeac0
Added order ID 25a8f5ea-e67a-11ea-9c17-7f242c2eeac0
...
</code></pre></div><p>After a while, as the throughput degrades and eventually exceeds the provisioned limit, Azure Cosmos DB will rate limit the application requests. This will manifest itself in the form of an error which looks similar to this:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">    Request rate is large: <span class="nv">ActivityID</span><span class="o">=</span>ac78fac3-5c36-4a20-8ad7-4b2d0768ffe4, <span class="nv">RetryAfterMs</span><span class="o">=</span>112, Additional <span class="nv">details</span><span class="o">=</span><span class="err">&#39;</span>Response status code does not indicate success: TooManyRequests <span class="o">(</span>429<span class="o">)</span><span class="p">;</span> Substatus: 3200<span class="p">;</span> ActivityId: ac78fac3-5c36-4a20-8ad7-4b2d0768ffe4<span class="p">;</span> Reason: <span class="o">({</span>
      <span class="s2">&#34;Errors&#34;</span>: <span class="o">[</span>
        <span class="s2">&#34;Request rate is large. More Request Units may be needed, so no changes were made. Please retry this request later. Learn more: http://aka.ms/cosmosdb-error-429&#34;</span>
      <span class="o">]</span>
    <span class="o">})</span><span class="p">;</span>
</code></pre></div><blockquote>
<p>In the error message above, notice the following: TooManyRequests (429) and RetryAfterMs=112</p>
</blockquote>
<p><strong>Observing Query errors</strong></p>
<p>To keep things simple, we will use the log output for testing/diagnostic purposes. Any error (related to rate–limiting in this case) encountered during query execution is intercepted by a <a href="https://pkg.go.dev/github.com/gocql/gocql?tab=doc#QueryObserver">gocql.QueryObserver</a>. The randomly generated order ID is also logged with each error message so that you can check the logs to confirm if the failed order has been re–tried and (eventually) stored in Azure Cosmos DB.</p>
<p>Here is the code snippet:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="o">...</span><span class="p">.</span>
<span class="kd">type</span> <span class="nx">OrderInsertErrorLogger</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">orderID</span> <span class="kt">string</span>
<span class="p">}</span>
    
<span class="c1">// implements gocql.QueryObserver
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="nx">OrderInsertErrorLogger</span><span class="p">)</span> <span class="nf">ObserveQuery</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">oq</span> <span class="nx">gocql</span><span class="p">.</span><span class="nx">ObservedQuery</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">oq</span><span class="p">.</span><span class="nx">Err</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Query error for order ID %sn%v&#34;</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">orderID</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
    
<span class="o">...</span><span class="p">.</span>
<span class="c1">// the Observer is associated with each query
</span><span class="c1"></span><span class="nx">rid</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">GenerateUUID</span><span class="p">()</span>
<span class="nx">err</span> <span class="o">:=</span> <span class="nx">cs</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="nx">insertQuery</span><span class="p">).</span><span class="nf">Bind</span><span class="p">(</span><span class="nx">rid</span><span class="p">,</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="o">+</span><span class="mi">50</span><span class="p">,</span> <span class="nx">fixedLocation</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()).</span><span class="nf">Observer</span><span class="p">(</span><span class="nx">OrderInsertErrorLogger</span><span class="p">{</span><span class="nx">orderID</span><span class="p">:</span> <span class="nx">rid</span><span class="p">}).</span><span class="nf">Exec</span><span class="p">()</span>
</code></pre></div><p><strong>How many orders made it through?</strong></p>
<p>Switch back to the load testing terminal and check some of the statistics (output has been redacted for brevity)</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">    Summary: 
    
      Total:        2.8507 secs 
      Slowest:      1.3437 secs 
      Fastest:      0.2428 secs 
      Average:      0.5389 secs 
      Requests/sec: 70.1592 
    .... 
    
    Status code distribution: 
      <span class="o">[</span>200<span class="o">]</span> <span class="m">300</span> responses
</code></pre></div><blockquote>
<p>The numbers will differ in your specific case depending on multiple factors.</p>
</blockquote>
<p>This is not a raw benchmarking test and neither do we have a production grade application, so you can ignore the  <code>Requests/sec</code> etc. But draw our attention to the <code>Status code distribution</code>  attribute which shows that our application responded with a <code>HTTP</code> <code>200</code>  for all the requests.</p>
<p>Let&rsquo;s confirm the final numbers. Open the <strong>Cassandra Shell</strong> in the Azure Cosmos DB portal and execute the same query:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">    <span class="k">select</span> count<span class="o">(</span>*<span class="o">)</span> from ordersapp.orders<span class="p">;</span>
    
    //output
    
    system.count<span class="o">(</span>*<span class="o">)</span>
    -----------------
        <span class="m">301</span>
</code></pre></div><p>You should see 300 <em>additional</em> rows (orders) have been inserted. The key takeaway is that all the orders were successfully stored in Azure Cosmos DB de–spite the rate limiting errors because our application code transparently retried them based on the Retry Policy that we configured (with a single line of code!)</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">clusterConfig</span><span class="p">.</span><span class="nx">RetryPolicy</span> <span class="p">=</span> <span class="nx">retry</span><span class="p">.</span><span class="nf">NewCosmosRetryPolicy</span><span class="p">(</span><span class="nx">numRetries</span><span class="p">)</span>
</code></pre></div><h3 id="a-note-on-dynamic-throughput-management">A note on dynamic throughput management</h3>
<p>If your application spends most of its time operating at about 60-70% of it&rsquo;s throughput, using <a href="https://docs.microsoft.com/azure/cosmos-db/provision-throughput-autoscale?WT.mc_id=devto-blog-abhishgu">Autoscale provisioned throughput</a> can help optimize your RU/s and cost usage by scaling down when not in use – you only pay for the resources that your workloads need on a per-hour basis.</p>
<p>So, what happens <em>without</em> the Retry Policy?</p>
<h3 id="deactivate-the-policy-to-see-the-difference">Deactivate the policy to see the difference</h3>
<p>Stop the application (press <code>control+c</code>  in the terminal), set an environment variable and re-start the application:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">    <span class="nb">export</span> <span class="nv">USE_RETRY_POLICY</span><span class="o">=</span><span class="nb">false</span> 
    go run main.go
</code></pre></div><p>Before running the load test again, make a note of the number of rows in the orders table using  <code>select count(*) from ordersapp.orders;</code></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">hey -t <span class="m">0</span> -n <span class="m">300</span> http://localhost:8080/orders
</code></pre></div><p>In the application logs, you will notice the same rate limiting errors. In the terminal where you ran the load test, at the end of the output summary, you will see that some the requests failed to complete successfully i.e. they returned a response other than <code>HTTP 200</code></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">    ...
    Status code distribution: 
      <span class="o">[</span>200<span class="o">]</span> <span class="m">240</span> responses 
      <span class="o">[</span>429<span class="o">]</span> <span class="m">60</span> responses
</code></pre></div><p>Because the Retry Policy was not enforced, the application no longer re–tried the requests that failed due to rate-limiting.</p>
<h3 id="increase-provisioned-throughput">Increase provisioned throughput</h3>
<p>You can increase the Request Units using the Azure Portal (for example, double it to <code>800</code> <code> RU/s</code>) and run the same load test</p>
<p><img src="https://devblogs.microsoft.com/cosmosdb/wp-content/uploads/sites/52/2020/09/increase-ru-300x79.png" alt=""></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">hey -t <span class="m">0</span> -n <span class="m">300</span> http://localhost:8080/orders
</code></pre></div><p>You will <strong>not</strong> see the rate limiting (<code>HTTP ``429</code>) errors now and relatively low numbers for latency, requests per second etc.</p>
<p>Try increasing the number of requests (use the <code>-n</code> flag) to see when the throughput threshold is breached for the application to get rate limited. As expected, all the orders will be persisted successfully (without any errors or retries)</p>
<p>The next section briefly covers how the <a href="https://github.com/abhirockzz/cosmos-cassandra-go-extension">custom Retry Policy</a> works.</p>
<blockquote>
<p>This is an experimental implementation, and you should write custom policies to suit fault-tolerance and performance requirements of your applications.</p>
</blockquote>
<h2 id="behind-the-scenes">Behind the scenes</h2>
<p><code>CosmosRetryPolicy</code> adheres to the <a href="https://pkg.go.dev/github.com/gocql/gocql?tab=doc#RetryPolicy">gocql.RetryPolicy</a> interface by implementing the <code>Attempt</code> and <code>GetRetry</code> functions.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">CosmosRetryPolicy</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">MaxRetryCount</span>         <span class="kt">int</span>
    <span class="nx">FixedBackOffTimeMs</span>    <span class="kt">int</span>
    <span class="nx">GrowingBackOffTimeMs</span>  <span class="kt">int</span>
    <span class="nx">numAttempts</span>           <span class="kt">int</span>
<span class="p">}</span>
</code></pre></div><p>Retry is initiated only if the number of retry attempts for that query are less than or equal to max retry config or max retry config is set to -1 (infinite retries)</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">crp</span> <span class="o">*</span><span class="nx">CosmosRetryPolicy</span><span class="p">)</span> <span class="nf">Attempt</span><span class="p">(</span><span class="nx">rq</span> <span class="nx">gocql</span><span class="p">.</span><span class="nx">RetryableQuery</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span> 
    <span class="nx">crp</span><span class="p">.</span><span class="nx">numAttempts</span> <span class="p">=</span> <span class="nx">rq</span><span class="p">.</span><span class="nf">Attempts</span><span class="p">()</span> 
    <span class="k">return</span> <span class="nx">rq</span><span class="p">.</span><span class="nf">Attempts</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="nx">crp</span><span class="p">.</span><span class="nx">MaxRetryCount</span> <span class="o">||</span> <span class="nx">crp</span><span class="p">.</span><span class="nx">MaxRetryCount</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">}</span>
</code></pre></div><p><code>GetRetryType</code> function detects the type of error and in the case or a rate-limited error (<code>HTTP 429</code>), it tries to extract the value for <code>RetryAfterMs</code> field (from the error message) and uses that to sleep before retrying the query.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">    <span class="kd">func</span> <span class="p">(</span><span class="nx">crp</span> <span class="o">*</span><span class="nx">CosmosRetryPolicy</span><span class="p">)</span> <span class="nf">GetRetryType</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="nx">gocql</span><span class="p">.</span><span class="nx">RetryType</span> <span class="p">{</span>
    
       <span class="k">switch</span> <span class="nx">err</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">default</span><span class="p">:</span>
             <span class="nx">retryAfterMs</span> <span class="o">:=</span> <span class="nx">crp</span><span class="p">.</span><span class="nf">getRetryAfterMs</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
             <span class="k">if</span> <span class="nx">retryAfterMs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
                 <span class="k">return</span> <span class="nx">gocql</span><span class="p">.</span><span class="nx">Rethrow</span>
             <span class="p">}</span>
            <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">retryAfterMs</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">gocql</span><span class="p">.</span><span class="nx">Retry</span>
    
    <span class="c1">//other case statements have been omitted for brevity
</span><span class="c1"></span>    <span class="p">}</span>
</code></pre></div><p>Azure Cosmos DB provides you the flexibility to not only configure and adjust your throughput requirements using a variety of ways but also provides the basic primitive that allows applications to handle rate limiting errors, thereby making them robust and fault-tolerant. This blog post demonstrated how you can do this for Go applications, but the concepts are applicable to any language and its respective <a href="https://docs.microsoft.com/azure/cosmos-db/cassandra-support?WT.mc_id=devto-blog-abhishgu#cassandra-protocol">CQL compatible</a> driver that you choose for working with the Cassandra API for Azure Cosmos DB.</p>
<h2 id="to-learn-more">To learn more:</h2>
<p>Check out some of these resources from the official documentation:</p>
<ul>
<li><a href="https://docs.microsoft.com/azure/cosmos-db/provision-throughput-autoscale?WT.mc_id=devto-blog-abhishgu">Use cases and benefits of Autoscale provisioned throughput</a></li>
<li><a href="https://docs.microsoft.com/azure/cosmos-db/cassandra-support?WT.mc_id=devto-blog-abhishgu">Details of the Cassandra API support in Azure Cosmos DB</a></li>
<li><a href="https://docs.microsoft.com/azure/cosmos-db/create-cassandra-go?WT.mc_id=devto-blog-abhishgu">Get up and running with a Go application and Cassandra API for Azure Cosmos DB</a></li>
<li><a href="https://docs.microsoft.com/azure/cosmos-db/create-cassandra-go?WT.mc_id=devto-blog-abhishgu">Frequently asked questions about the Cassandra API in Azure Cosmos DB</a></li>
<li><a href="https://docs.microsoft.com/azure/cosmos-db/request-units?WT.mc_id=devto-blog-abhishgu">Request Units concepts</a></li>
</ul>


        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://abhirockzz.github.io/posts/azure-stream-analytics-tutorial/" data-toggle="tooltip" data-placement="top" title="Build a pipeline to join streams of real time data">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://abhirockzz.github.io/posts/kafka-azure-data-explorer-kubernetes/" data-toggle="tooltip" data-placement="top" title="Data Ingestion into Azure Data Explorer using Kafka Connect on Kubernetes">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://github.com/abhirockzz" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/abhi_tweeter" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/abhirockzz" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://abhirockzz.github.io">Abhishek Gupta</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2021
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://abhirockzz.github.io/">Foo Bar Baz</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.80.0</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://abhirockzz.github.io/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://abhirockzz.github.io/js/load-photoswipe.js"></script>









    
  </body>
</html>

