<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Build fault tolerant applications with Cassandra API for Azure Cosmos DB - Abhishek&#39;s dev blog</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Build fault tolerant applications with Cassandra API for Azure Cosmos DB" />
<meta property="og:description" content="Azure Cosmos DB is a resource governed system that allows you to execute a certain number of operations per second based on the provisioned throughput you have configured." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://abhirockzz.github.io/abhirockzz.github.io/posts/cosmosdb-fault-tolerant-apps/" />
<meta property="article:published_time" content="2020-09-10T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-09-10T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Build fault tolerant applications with Cassandra API for Azure Cosmos DB"/>
<meta name="twitter:description" content="Azure Cosmos DB is a resource governed system that allows you to execute a certain number of operations per second based on the provisioned throughput you have configured."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://abhirockzz.github.io/abhirockzz.github.io/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://abhirockzz.github.io/abhirockzz.github.io/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://abhirockzz.github.io/abhirockzz.github.io/css/custom.css" />
	<link rel="stylesheet" type="text/css" href="https://abhirockzz.github.io/abhirockzz.github.io/css/dark.css" media="(prefers-color-scheme: dark)" />
	<link rel="stylesheet" type="text/css" href="https://abhirockzz.github.io/abhirockzz.github.io/css/custom-dark.css" media="(prefers-color-scheme: dark)" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<script src="https://abhirockzz.github.io/abhirockzz.github.io/js/main.js"></script>
	<script src="https://abhirockzz.github.io/abhirockzz.github.io/js/abc.js"></script>
	<script src="https://abhirockzz.github.io/abhirockzz.github.io/js/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://abhirockzz.github.io/abhirockzz.github.io/">
	<h1 class="site-title"><a href="https://abhirockzz.github.io/abhirockzz.github.io/">Abhishek&#39;s dev blog</a></h1>
	<div class="site-description"><h2>Mostly about Kafka, Databases, Kubernetes and other open source topics</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/abhirockzz/" title="Github"><i data-feather="github"></i></a><a href="https://twitter.com/abhi_tweeter" title="Twitter"><i data-feather="twitter"></i></a><a href="https://www.linkedin.com/in/abhirockzz/" title="LinkedIn"><i data-feather="linkedin"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/abhirockzz.github.io/">Home</a>
			</li>
			
			<li>
				<a href="/abhirockzz.github.io/posts">All posts</a>
			</li>
			
			<li>
				<a href="/abhirockzz.github.io/about">About</a>
			</li>
			
			<li>
				<a href="/abhirockzz.github.io/books">Books</a>
			</li>
			
			<li>
				<a href="/abhirockzz.github.io/presentations">Presentations</a>
			</li>
			
			<li>
				<a href="/abhirockzz.github.io/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Build fault tolerant applications with Cassandra API for Azure Cosmos DB</h1>
			<div class="meta">Posted at &mdash; Sep 10, 2020</div>
		</div>

		<div class="markdown">
			<p><a href="http://www.azurecosmosdb.com/">Azure Cosmos DB</a> is a resource governed system that allows you to execute a certain number of operations per second based on the <a href="https://docs.microsoft.com/azure/cosmos-db/set-throughput">provisioned throughput</a> you have configured. If clients exceed that limit and consume more <a href="https://docs.microsoft.com/azure/cosmos-db/request-units">request units</a> than what was provisioned, it leads to rate limiting of subsequent requests and exceptions being thrown – they are also referred to as <a href="https://docs.microsoft.com/rest/api/cosmos-db/http-status-codes-for-cosmosdb?WT.mc_id=devto-blog-abhishgu">429 errors</a>.</p>
<p>With the help of a practical example, I&rsquo;ll demonstrate how to incorporate fault-tolerance in your <a href="https://golang.org/">Go</a> applications by handling and retrying operations affected by these rate limiting errors. To help you follow along, the sample application code for this blog is available <a href="https://github.com/abhirockzz/cosmos-go-rate-limiting">on GitHub</a> - it uses the <a href="https://github.com/gocql/gocql">gocql driver for Apache Cassandra</a>.</p>
<p>In this post, we&rsquo;ll go through:</p>
<ul>
<li>Initial setup and configuration before running the sample application</li>
<li>Execution of various load test scenarios and analyze the results</li>
<li>A quick overview of the Retry Policy implementation.</li>
</ul>
<p>One way of tackling rate limiting is by adjusting provisioned throughput to meet your application requirements. There are <a href="https://docs.microsoft.com/azure/cosmos-db/manage-scale-cassandra?WT.mc_id=devto-blog-abhishgu#manage-scaling">multiple ways to do this</a>, including using Azure portal, Azure CLI, and CQL (Cassandra Query Language) commands.</p>
<p><strong>But, what if you wanted to handle these errors in the application itself?</strong></p>
<p>The good thing is that the Cassandra API for Azure Cosmos DB translates the rate limiting exceptions into overloaded errors on the Cassandra native protocol. Since the <code>gocql</code> driver allows you to plugin your own <a href="https://pkg.go.dev/github.com/gocql/gocql?tab=doc#RetryPolicy">RetryPolicy</a>, you can write a custom implementation to intercept these errors and retry them after a certain (cool down) time period. This policy can then <a href="https://pkg.go.dev/github.com/gocql/gocql?tab=doc#Query.RetryPolicy">be applied to each Query</a> or at a global level using a <a href="https://pkg.go.dev/github.com/gocql/gocql?tab=doc#ClusterConfig">ClusterConfig</a>.</p>
<p>The <a href="https://github.com/Azure/azure-cosmos-cassandra-extensions">Azure Cosmos DB extension</a> library makes it quite easy to use Retry Policies in your Java applications. An equivalent Go version is <a href="https://github.com/abhirockzz/cosmos-cassandra-go-extension">available on GitHub</a> and has been used in the sample application for this blog post.</p>
<h2 id="retry-policy-in-action">Retry Policy in action</h2>
<p>As promised, you will walk through the entire process using a simple yet practical example. The sample application used to demonstrate the concepts is a service that exposes a REST endpoint to <code>POST</code> orders data which is persisted to a Cassandra table in Azure Cosmos DB.</p>
<p>You will run a few load tests on this API service to see how rate limiting manifests itself and how it&rsquo;s handled.</p>
<h3 id="pre-requisites">Pre-requisites</h3>
<p>Start by installing <a href="https://github.com/rakyll/hey">hey</a>, a load testing program. You can download OS specific binaries (64-bit) for <a href="https://storage.googleapis.com/hey-release/hey_linux_amd64">Linux</a>, <a href="https://storage.googleapis.com/hey-release/hey_darwin_amd64">Mac</a> and <a href="https://storage.googleapis.com/hey-release/hey_windows_amd64">Windows</a> (please refer to <a href="https://github.com/rakyll/hey#installation">the GitHub repo</a> for latest information in case you face issues downloading the utility)</p>
<blockquote>
<p>You can use any other tool that allows you to generate load on an HTTP endpoint</p>
</blockquote>
<p>Clone this GitHub repo and change into the right directory:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone github.com/abhirockzz/cosmos-go-rate-limiting 
<span style="color:#b58900">cd</span> cosmos-go-rate-limiting
</code></pre></div><h3 id="setup-azure-cosmos-db">Setup Azure Cosmos DB</h3>
<p>Create an Azure <a href="https://docs.microsoft.com/azure/cosmos-db/create-cassandra-api-account-java?WT.mc_id=devto-blog-abhishgu#create-a-database-account">Cosmos DB account</a> with the Cassandra API option selected</p>
<p>To create a Keyspace and Table, use the following <code>CQL</code>:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">    <span style="color:#719e07">CREATE</span> KEYSPACE ordersapp <span style="color:#719e07">WITH</span> REPLICATION <span style="color:#719e07">=</span> {<span style="color:#2aa198">&#39;class&#39;</span> : <span style="color:#2aa198">&#39;SimpleStrategy&#39;</span>};
    
    <span style="color:#719e07">CREATE</span> <span style="color:#719e07">TABLE</span> ordersapp.orders (
        id uuid <span style="color:#719e07">PRIMARY</span> <span style="color:#719e07">KEY</span>,
        amount <span style="color:#b58900">int</span>,
        <span style="color:#719e07">state</span> <span style="color:#b58900">text</span>,
        time <span style="color:#719e07">timestamp</span>
    );
</code></pre></div><h3 id="start-the-application">Start the application</h3>
<p>Open a terminal and set the environment variables for the application:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">COSMOSDB_CASSANDRA_CONTACT_POINT</span><span style="color:#719e07">=</span>.cassandra.cosmos.azure.com 
<span style="color:#b58900">export</span> <span style="color:#268bd2">COSMOSDB_CASSANDRA_PORT</span><span style="color:#719e07">=</span><span style="color:#2aa198">10350</span> 
<span style="color:#b58900">export</span> <span style="color:#268bd2">COSMOSDB_CASSANDRA_USER</span><span style="color:#719e07">=</span> 
<span style="color:#b58900">export</span> <span style="color:#268bd2">COSMOSDB_CASSANDRA_PASSWORD</span><span style="color:#719e07">=</span> 
<span style="color:#586e75">#optional (default: 5) </span>
<span style="color:#586e75">#export MAX_RETRIES=</span>
</code></pre></div><p>To start the application:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go run main.go 
    
//wait <span style="color:#719e07">for</span> this output 
Connected to Azure Cosmos DB
</code></pre></div><p>To test whether the application is working as expected, insert a few orders by invoking the REST endpoint (once for each order) from a different terminal:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl http://localhost:8080/orders
</code></pre></div><p>The application generates random data so you don&rsquo;t have to enter it while invoking the endpoint</p>
<p>Confirm that the order was successfully stored. You can use the <a href="https://docs.microsoft.com/azure/cosmos-db/cassandra-support?WT.mc_id=devto-blog-abhishgu#hosted-cql-shell-preview">hosted CQL shell in the Azure portal</a> and execute the below query:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#719e07">select</span> <span style="color:#719e07">count</span>(<span style="color:#719e07">*</span>) <span style="color:#719e07">from</span> ordersapp.orders;
    
<span style="color:#719e07">//</span> you should see this <span style="color:#719e07">output</span>
<span style="color:#719e07">system</span>.<span style="color:#719e07">count</span>(<span style="color:#719e07">*</span>) 
<span style="color:#586e75">----------------- 
</span><span style="color:#586e75"></span>        <span style="color:#2aa198">1</span> 
(<span style="color:#2aa198">1</span> <span style="color:#719e07">rows</span>)
</code></pre></div><p>You&rsquo;re all set.</p>
<h3 id="let-the-load-tests-begin">Let the load tests begin!</h3>
<p>Invoke the REST endpoint with 300 requests. This is enough to overload the system since you only have 400 RU/s allocated by default.</p>
<p>To start the load test:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">hey -t <span style="color:#2aa198">0</span> -n <span style="color:#2aa198">300</span> http://localhost:8080/orders
</code></pre></div><p>Notice the logs in the application terminal. In the beginning, you will see that the orders are being successfully created. For example:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Added order ID 25a8cec1-e67a-11ea-9c17-7f242c2eeac0
Added order ID 25a8f5ef-e67a-11ea-9c17-7f242c2eeac0
Added order ID 25a8f5ea-e67a-11ea-9c17-7f242c2eeac0
...
</code></pre></div><p>After a while, as the throughput degrades and eventually exceeds the provisioned limit, Azure Cosmos DB will rate limit the application requests. This will manifest itself in the form of an error which looks similar to this:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">    Request rate is large: <span style="color:#268bd2">ActivityID</span><span style="color:#719e07">=</span>ac78fac3-5c36-4a20-8ad7-4b2d0768ffe4, <span style="color:#268bd2">RetryAfterMs</span><span style="color:#719e07">=</span>112, Additional <span style="color:#268bd2">details</span><span style="color:#719e07">=</span>&#39;Response status code does not indicate success: TooManyRequests <span style="color:#719e07">(</span>429<span style="color:#719e07">)</span>; Substatus: 3200; ActivityId: ac78fac3-5c36-4a20-8ad7-4b2d0768ffe4; Reason: <span style="color:#719e07">({</span>
      <span style="color:#2aa198">&#34;Errors&#34;</span>: <span style="color:#719e07">[</span>
        <span style="color:#2aa198">&#34;Request rate is large. More Request Units may be needed, so no changes were made. Please retry this request later. Learn more: http://aka.ms/cosmosdb-error-429&#34;</span>
      <span style="color:#719e07">]</span>
    <span style="color:#719e07">})</span>;
</code></pre></div><blockquote>
<p>In the error message above, notice the following: TooManyRequests (429) and RetryAfterMs=112</p>
</blockquote>
<p><strong>Observing Query errors</strong></p>
<p>To keep things simple, we will use the log output for testing/diagnostic purposes. Any error (related to rate–limiting in this case) encountered during query execution is intercepted by a <a href="https://pkg.go.dev/github.com/gocql/gocql?tab=doc#QueryObserver">gocql.QueryObserver</a>. The randomly generated order ID is also logged with each error message so that you can check the logs to confirm if the failed order has been re–tried and (eventually) stored in Azure Cosmos DB.</p>
<p>Here is the code snippet:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#719e07">...</span>.
<span style="color:#268bd2">type</span> OrderInsertErrorLogger <span style="color:#268bd2">struct</span> {
    orderID <span style="color:#dc322f">string</span>
}
    
<span style="color:#586e75">// implements gocql.QueryObserver
</span><span style="color:#586e75"></span><span style="color:#268bd2">func</span> (l OrderInsertErrorLogger) <span style="color:#268bd2">ObserveQuery</span>(ctx context.Context, oq gocql.ObservedQuery) {
    err <span style="color:#719e07">:=</span> oq.Err
    <span style="color:#719e07">if</span> err <span style="color:#719e07">!=</span> <span style="color:#cb4b16">nil</span> {
        log.<span style="color:#268bd2">Printf</span>(<span style="color:#2aa198">&#34;Query error for order ID %sn%v&#34;</span>, l.orderID, err)
    }
}
    
<span style="color:#719e07">...</span>.
<span style="color:#586e75">// the Observer is associated with each query
</span><span style="color:#586e75"></span>rid, _ <span style="color:#719e07">:=</span> uuid.<span style="color:#268bd2">GenerateUUID</span>()
err <span style="color:#719e07">:=</span> cs.<span style="color:#268bd2">Query</span>(insertQuery).<span style="color:#268bd2">Bind</span>(rid, rand.<span style="color:#268bd2">Intn</span>(<span style="color:#2aa198">200</span>)<span style="color:#719e07">+</span><span style="color:#2aa198">50</span>, fixedLocation, time.<span style="color:#268bd2">Now</span>()).<span style="color:#268bd2">Observer</span>(OrderInsertErrorLogger{orderID: rid}).<span style="color:#268bd2">Exec</span>()
</code></pre></div><p><strong>How many orders made it through?</strong></p>
<p>Switch back to the load testing terminal and check some of the statistics (output has been redacted for brevity)</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    Summary: 
    
      Total:        2.8507 secs 
      Slowest:      1.3437 secs 
      Fastest:      0.2428 secs 
      Average:      0.5389 secs 
      Requests/sec: 70.1592 
    .... 
    
    Status code distribution: 
      <span style="color:#719e07">[</span>200<span style="color:#719e07">]</span> <span style="color:#2aa198">300</span> responses
</code></pre></div><blockquote>
<p>The numbers will differ in your specific case depending on multiple factors.</p>
</blockquote>
<p>This is not a raw benchmarking test and neither do we have a production grade application, so you can ignore the  <code>Requests/sec</code> etc. But draw our attention to the <code>Status code distribution</code>  attribute which shows that our application responded with a <code>HTTP</code> <code>200</code>  for all the requests.</p>
<p>Let&rsquo;s confirm the final numbers. Open the <strong>Cassandra Shell</strong> in the Azure Cosmos DB portal and execute the same query:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">    <span style="color:#719e07">select</span> count<span style="color:#719e07">(</span>*<span style="color:#719e07">)</span> from ordersapp.orders;
    
    //output
    
    system.count<span style="color:#719e07">(</span>*<span style="color:#719e07">)</span>
    -----------------
        <span style="color:#2aa198">301</span>
</code></pre></div><p>You should see 300 <em>additional</em> rows (orders) have been inserted. The key takeaway is that all the orders were successfully stored in Azure Cosmos DB de–spite the rate limiting errors because our application code transparently retried them based on the Retry Policy that we configured (with a single line of code!)</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">clusterConfig.RetryPolicy = retry.<span style="color:#268bd2">NewCosmosRetryPolicy</span>(numRetries)
</code></pre></div><h3 id="a-note-on-dynamic-throughput-management">A note on dynamic throughput management</h3>
<p>If your application spends most of its time operating at about 60-70% of it&rsquo;s throughput, using <a href="https://docs.microsoft.com/azure/cosmos-db/provision-throughput-autoscale?WT.mc_id=devto-blog-abhishgu">Autoscale provisioned throughput</a> can help optimize your RU/s and cost usage by scaling down when not in use – you only pay for the resources that your workloads need on a per-hour basis.</p>
<p>So, what happens <em>without</em> the Retry Policy?</p>
<h3 id="deactivate-the-policy-to-see-the-difference">Deactivate the policy to see the difference</h3>
<p>Stop the application (press <code>control+c</code>  in the terminal), set an environment variable and re-start the application:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    <span style="color:#b58900">export</span> <span style="color:#268bd2">USE_RETRY_POLICY</span><span style="color:#719e07">=</span><span style="color:#b58900">false</span> 
    go run main.go
</code></pre></div><p>Before running the load test again, make a note of the number of rows in the orders table using  <code>select count(*) from ordersapp.orders;</code></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">hey -t <span style="color:#2aa198">0</span> -n <span style="color:#2aa198">300</span> http://localhost:8080/orders
</code></pre></div><p>In the application logs, you will notice the same rate limiting errors. In the terminal where you ran the load test, at the end of the output summary, you will see that some the requests failed to complete successfully i.e. they returned a response other than <code>HTTP 200</code></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">    ...
    Status code distribution: 
      <span style="color:#719e07">[</span>200<span style="color:#719e07">]</span> <span style="color:#2aa198">240</span> responses 
      <span style="color:#719e07">[</span>429<span style="color:#719e07">]</span> <span style="color:#2aa198">60</span> responses
</code></pre></div><p>Because the Retry Policy was not enforced, the application no longer re–tried the requests that failed due to rate-limiting.</p>
<h3 id="increase-provisioned-throughput">Increase provisioned throughput</h3>
<p>You can increase the Request Units using the Azure Portal (for example, double it to <code>800</code> <code> RU/s</code>) and run the same load test</p>
<p><img src="https://devblogs.microsoft.com/cosmosdb/wp-content/uploads/sites/52/2020/09/increase-ru-300x79.png" alt=""></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">hey -t <span style="color:#2aa198">0</span> -n <span style="color:#2aa198">300</span> http://localhost:8080/orders
</code></pre></div><p>You will <strong>not</strong> see the rate limiting (<code>HTTP ``429</code>) errors now and relatively low numbers for latency, requests per second etc.</p>
<p>Try increasing the number of requests (use the <code>-n</code> flag) to see when the throughput threshold is breached for the application to get rate limited. As expected, all the orders will be persisted successfully (without any errors or retries)</p>
<p>The next section briefly covers how the <a href="https://github.com/abhirockzz/cosmos-cassandra-go-extension">custom Retry Policy</a> works.</p>
<blockquote>
<p>This is an experimental implementation, and you should write custom policies to suit fault-tolerance and performance requirements of your applications.</p>
</blockquote>
<h2 id="behind-the-scenes">Behind the scenes</h2>
<p><code>CosmosRetryPolicy</code> adheres to the <a href="https://pkg.go.dev/github.com/gocql/gocql?tab=doc#RetryPolicy">gocql.RetryPolicy</a> interface by implementing the <code>Attempt</code> and <code>GetRetry</code> functions.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#268bd2">type</span> CosmosRetryPolicy <span style="color:#268bd2">struct</span> {
    MaxRetryCount         <span style="color:#dc322f">int</span>
    FixedBackOffTimeMs    <span style="color:#dc322f">int</span>
    GrowingBackOffTimeMs  <span style="color:#dc322f">int</span>
    numAttempts           <span style="color:#dc322f">int</span>
}
</code></pre></div><p>Retry is initiated only if the number of retry attempts for that query are less than or equal to max retry config or max retry config is set to -1 (infinite retries)</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#268bd2">func</span> (crp <span style="color:#719e07">*</span>CosmosRetryPolicy) <span style="color:#268bd2">Attempt</span>(rq gocql.RetryableQuery) <span style="color:#dc322f">bool</span> { 
    crp.numAttempts = rq.<span style="color:#268bd2">Attempts</span>() 
    <span style="color:#719e07">return</span> rq.<span style="color:#268bd2">Attempts</span>() <span style="color:#719e07">&lt;=</span> crp.MaxRetryCount <span style="color:#719e07">||</span> crp.MaxRetryCount <span style="color:#719e07">==</span> <span style="color:#719e07">-</span><span style="color:#2aa198">1</span>
}
</code></pre></div><p><code>GetRetryType</code> function detects the type of error and in the case or a rate-limited error (<code>HTTP 429</code>), it tries to extract the value for <code>RetryAfterMs</code> field (from the error message) and uses that to sleep before retrying the query.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#268bd2">func</span> (crp <span style="color:#719e07">*</span>CosmosRetryPolicy) <span style="color:#268bd2">GetRetryType</span>(err <span style="color:#dc322f">error</span>) gocql.RetryType {
    
       <span style="color:#719e07">switch</span> err.(<span style="color:#268bd2">type</span>) {
       <span style="color:#719e07">default</span>:
             retryAfterMs <span style="color:#719e07">:=</span> crp.<span style="color:#268bd2">getRetryAfterMs</span>(err.<span style="color:#268bd2">Error</span>())
             <span style="color:#719e07">if</span> retryAfterMs <span style="color:#719e07">==</span> <span style="color:#719e07">-</span><span style="color:#2aa198">1</span> {
                 <span style="color:#719e07">return</span> gocql.Rethrow
             }
            time.<span style="color:#268bd2">Sleep</span>(retryAfterMs)
            <span style="color:#719e07">return</span> gocql.Retry
    
    <span style="color:#586e75">//other case statements have been omitted for brevity
</span><span style="color:#586e75"></span>    }
</code></pre></div><p>Azure Cosmos DB provides you the flexibility to not only configure and adjust your throughput requirements using a variety of ways but also provides the basic primitive that allows applications to handle rate limiting errors, thereby making them robust and fault-tolerant. This blog post demonstrated how you can do this for Go applications, but the concepts are applicable to any language and its respective <a href="https://docs.microsoft.com/azure/cosmos-db/cassandra-support?WT.mc_id=devto-blog-abhishgu#cassandra-protocol">CQL compatible</a> driver that you choose for working with the Cassandra API for Azure Cosmos DB.</p>
<h2 id="to-learn-more">To learn more:</h2>
<p>Check out some of these resources from the official documentation:</p>
<ul>
<li><a href="https://docs.microsoft.com/azure/cosmos-db/provision-throughput-autoscale?WT.mc_id=devto-blog-abhishgu">Use cases and benefits of Autoscale provisioned throughput</a></li>
<li><a href="https://docs.microsoft.com/azure/cosmos-db/cassandra-support?WT.mc_id=devto-blog-abhishgu">Details of the Cassandra API support in Azure Cosmos DB</a></li>
<li><a href="https://docs.microsoft.com/azure/cosmos-db/create-cassandra-go?WT.mc_id=devto-blog-abhishgu">Get up and running with a Go application and Cassandra API for Azure Cosmos DB</a></li>
<li><a href="https://docs.microsoft.com/azure/cosmos-db/create-cassandra-go?WT.mc_id=devto-blog-abhishgu">Frequently asked questions about the Cassandra API in Azure Cosmos DB</a></li>
<li><a href="https://docs.microsoft.com/azure/cosmos-db/request-units?WT.mc_id=devto-blog-abhishgu">Request Units concepts</a></li>
</ul>

		</div>

		<div class="post-tags">
			
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © Abhishek Gupta, 2021 |  <a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-54762029-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script>feather.replace()</script>
</body>
</html>
