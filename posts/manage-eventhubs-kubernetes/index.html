<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Orchestrate Azure Event Hubs via Kubernetes - Abhishek&#39;s dev blog</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Orchestrate Azure Event Hubs via Kubernetes" />
<meta property="og:description" content="Manage Azure Event Hubs with Azure Service Operator on Kubernetes" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://abhirockzz.github.io/abhirockzz.github.io/posts/manage-eventhubs-kubernetes/" />
<meta property="article:published_time" content="2020-07-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-07-13T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Orchestrate Azure Event Hubs via Kubernetes"/>
<meta name="twitter:description" content="Manage Azure Event Hubs with Azure Service Operator on Kubernetes"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://abhirockzz.github.io/abhirockzz.github.io/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://abhirockzz.github.io/abhirockzz.github.io/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://abhirockzz.github.io/abhirockzz.github.io/css/custom.css" />
	<link rel="stylesheet" type="text/css" href="https://abhirockzz.github.io/abhirockzz.github.io/css/dark.css" media="(prefers-color-scheme: dark)" />
	<link rel="stylesheet" type="text/css" href="https://abhirockzz.github.io/abhirockzz.github.io/css/custom-dark.css" media="(prefers-color-scheme: dark)" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<script src="https://abhirockzz.github.io/abhirockzz.github.io/js/main.js"></script>
	<script src="https://abhirockzz.github.io/abhirockzz.github.io/js/abc.js"></script>
	<script src="https://abhirockzz.github.io/abhirockzz.github.io/js/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://abhirockzz.github.io/abhirockzz.github.io/">
	<h1 class="site-title"><a href="https://abhirockzz.github.io/abhirockzz.github.io/">Abhishek&#39;s dev blog</a></h1>
	<div class="site-description"><h2>Mostly about Kafka, Databases, Kubernetes and other open source topics</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/abhirockzz/" title="Github"><i data-feather="github"></i></a><a href="https://twitter.com/abhi_tweeter" title="Twitter"><i data-feather="twitter"></i></a><a href="https://www.linkedin.com/in/abhirockzz/" title="LinkedIn"><i data-feather="linkedin"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/abhirockzz.github.io/">Home</a>
			</li>
			
			<li>
				<a href="/abhirockzz.github.io/posts">All posts</a>
			</li>
			
			<li>
				<a href="/abhirockzz.github.io/about">About</a>
			</li>
			
			<li>
				<a href="/abhirockzz.github.io/books">Books</a>
			</li>
			
			<li>
				<a href="/abhirockzz.github.io/presentations">Presentations</a>
			</li>
			
			<li>
				<a href="/abhirockzz.github.io/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Orchestrate Azure Event Hubs via Kubernetes</h1>
			<div class="meta">Posted at &mdash; Jul 13, 2020</div>
		</div>

		<div class="markdown">
			<p><a href="https://github.com/Azure/azure-service-operator">Azure Service Operator</a> is an open source project to help you provision and manage Azure services using Kubernetes. Developers can use it to provision Azure services from any environment, be it Azure, any other cloud provider or on-premises - Kubernetes is the only common denominator!</p>
<p>It can also be included as a part of CI/CD pipelines to create, use and tear down Azure resources on-demand. Behind the scenes, all the heavy lifting is taken care of by a combination of <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">Custom Resource Definitions</a> which define Azure resources and the corresponding <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/">Kubernetes Operator(s)</a> which ensure that the state defined by the Custom Resource Definition is reflected in Azure as well.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/i/2x8pc7at7sog3f1xuktb.jpg" alt=""></p>
<blockquote>
<p>Read more in the recent announcement here - <a href="https://cloudblogs.microsoft.com/opensource/2020/06/25/announcing-azure-service-operator-kubernetes/">https://cloudblogs.microsoft.com/opensource/2020/06/25/announcing-azure-service-operator-kubernetes/</a></p>
</blockquote>
<p>In this blog post:</p>
<ul>
<li>You will get a high level overview of Azure Service Operator (sometimes referred to as <code>ASO</code> in this blog)</li>
<li>How to set it up and use it to provision <a href="https://docs.microsoft.com/azure/event-hubs/?WT.mc_id=devto-blog-abhishgu">Azure Event Hubs</a></li>
<li>Deploy apps to Kubernetes which use the Azure Event Hubs cluster</li>
</ul>
<blockquote>
<p>All the artefacts are available on this GitHub repo <a href="https://github.com/abhirockzz/eventhubs-using-aso-on-k8s">https://github.com/abhirockzz/eventhubs-using-aso-on-k8s</a></p>
</blockquote>
<h2 id="getting-started">Getting started&hellip;.</h2>
<p><a href="https://github.com/Azure/azure-service-operator#supported-azure-services">Azure Service Operator supports many Azure services</a> including databases (<a href="https://docs.microsoft.com/azure/cosmos-db/introduction?WT.mc_id=devto-blog-abhishgu">Azure Cosmos DB</a>, <a href="https://docs.microsoft.com/azure/postgresql/overview?WT.mc_id=devto-blog-abhishgu">PostgreSQL</a>, <a href="https://docs.microsoft.com/azure/mysql/overview?WT.mc_id=devto-blog-abhishgu">MySQL</a>, <a href="https://docs.microsoft.com/azure/azure-sql/?WT.mc_id=devto-blog-abhishgu">Azure SQL</a> etc.), core infrastructure components (<a href="https://docs.microsoft.com/azure/virtual-machines/linux/overview?WT.mc_id=devto-blog-abhishgu">Virtual Machines</a>, <a href="https://docs.microsoft.com/azure/virtual-machine-scale-sets/overview?WT.mc_id=devto-blog-abhishgu">VM Scale sets</a>, Virtual Networks etc.) and others as well.</p>
<p>It also supports Azure Event Hubs which is a fully managed data streaming platform and event ingestion service <a href="https://docs.microsoft.com/azure/event-hubs/event-hubs-for-kafka-ecosystem-overview?WT.mc_id=devto-blog-abhishgu">with support for Apache Kafka</a> and other tools in the Kafka ecosystem. With Azure Service Operator you can provision and manage Azure Event Hubs namespaces, Event Hub and Consumer Groups.</p>
<p>So, let&rsquo;s dive in without further ado! Before we do that, please note that you will need the following in order to try out this tutorial:</p>
<h3 id="pre-requisites">Pre-requisites</h3>
<p>Start by getting an Azure account if you don&rsquo;t have one already - you can <a href="https://azure.microsoft.com/free/?WT.mc_id=devto-blog-abhishgu">get for FREE!</a> Please make sure you&rsquo;ve <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a> and <a href="https://helm.sh/docs/intro/install/">Helm 3</a> installed as well.</p>
<p>Although the steps outlined in this blog should work with any Kubernetes cluster (including <code>minikube</code> etc.), I used <a href="https://docs.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=devto-blog-abhishgu">Azure Kubernetes Service (AKS)</a>. You can setup a cluster using <a href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?WT.mc_id=devto-blog-abhishgu">Azure CLI</a>, <a href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-portal?WT.mc_id=devto-blog-abhishgu">Azure portal</a> or even an <a href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough-rm-template?WT.mc_id=devto-blog-abhishgu">ARM template</a>. Once that&rsquo;s done, simply <a href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?WT.mc_id=devto-blog-abhishgu#connect-to-the-cluster">configure <code>kubectl</code> to point to it</a></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">az aks get-credentials --resource-group &lt;CLUSTER_RESOURCE_GROUP&gt; --name &lt;CLUSTER_NAME&gt;
</code></pre></div><p>Ok, you&rsquo;re now ready to&hellip;</p>
<h2 id="-install-azure-service-operator">&hellip; Install Azure Service Operator</h2>
<p><img src="https://media.giphy.com/media/lYZjoIy0UOEJa/giphy.gif" alt=""></p>
<p>Nothing too fancy about it&hellip; just following the steps to install it using <code>Helm</code></p>
<p>Start by installing <a href="https://cert-manager.io/docs/installation/kubernetes/">cert-manager</a></p>
<h3 id="setup-cert-manager">Setup <code>cert-manager</code></h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create namespace cert-manager

kubectl label namespace cert-manager cert-manager.io/disable-validation<span style="color:#719e07">=</span><span style="color:#b58900">true</span>

kubectl apply --validate<span style="color:#719e07">=</span><span style="color:#b58900">false</span> -f https://github.com/jetstack/cert-manager/releases/download/v0.12.0/cert-manager.yaml

//make sure cert manager is up and running
kubectl rollout status -n cert-manager deploy/cert-manager-webhook
</code></pre></div><h3 id="authentication">Authentication&hellip;</h3>
<p>Since the operator will create resource on Azure, we need to authorize it to do so by providing the appropriate credentials. Currently, you can use <a href="https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview?WT.mc_id=devto-blog-abhishgu">Managed Identity</a> or <a href="https://docs.microsoft.com/azure/active-directory/develop/app-objects-and-service-principals?WT.mc_id=devto-blog-abhishgu#service-principal-object">Service Principal</a></p>
<p>I will be using a Service Principal, so let&rsquo;s start by creating one (with <a href="https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest&amp;WT.mc_id=devto-blog-abhishgu">Azure CLI</a>) using the <a href="https://docs.microsoft.com/cli/azure/ad/sp?view=azure-cli-latest&amp;WT.mc_id=devto-blog-abhishgu#az-ad-sp-create-for-rbac">az ad sp create-for-rbac</a> command</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">az ad sp create-for-rbac -n &#34;aso-rbac-sp&#34;

//JSON output
{
  &#34;appId&#34;: &#34;eb4280db-4242-4ed0-a7d2-42424242f0d0&#34;,
  &#34;displayName&#34;: &#34;aso-rbac-sp&#34;,
  &#34;name&#34;: &#34;http://aso-rbac-sp&#34;,
  &#34;password&#34;: &#34;7d69a422-428d-42d4-a242-cd1d425424b2&#34;,
  &#34;tenant&#34;: &#34;42f988bf-42f1-42af-42ab-2d7cd421db42&#34;
}
</code></pre></div><h3 id="install">Install</h3>
<p>Setup required environment variables:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">AZURE_SUBSCRIPTION_ID</span><span style="color:#719e07">=</span>&lt;enter Azure subscription ID&gt;
<span style="color:#b58900">export</span> <span style="color:#268bd2">AZURE_TENANT_ID</span><span style="color:#719e07">=</span>&lt;enter value from the <span style="color:#2aa198">&#34;tenant&#34;</span> attribute in the JSON payload above&gt;
<span style="color:#b58900">export</span> <span style="color:#268bd2">AZURE_CLIENT_ID</span><span style="color:#719e07">=</span>&lt;enter value from the <span style="color:#2aa198">&#34;appId&#34;</span> attribute in the JSON payload above&gt;
<span style="color:#b58900">export</span> <span style="color:#268bd2">AZURE_CLIENT_SECRET</span><span style="color:#719e07">=</span>&lt;enter value from the <span style="color:#2aa198">&#34;password&#34;</span> attribute in the JSON payload above&gt;
<span style="color:#b58900">export</span> <span style="color:#268bd2">AZURE_SERVICE_OPERATOR_NAMESPACE</span><span style="color:#719e07">=</span>&lt;name of the namespace into which ASO will be installed&gt;
</code></pre></div><p>Add the repo, create namespace</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">helm repo add azureserviceoperator https://raw.githubusercontent.com/Azure/azure-service-operator/master/charts

kubectl create namespace <span style="color:#268bd2">$AZURE_SERVICE_OPERATOR_NAMESPACE</span>
</code></pre></div><p>Use <code>helm upgrade</code> to initiate setup:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">helm upgrade --install aso azureserviceoperator/azure-service-operator <span style="color:#cb4b16">\
</span><span style="color:#cb4b16"></span>-n <span style="color:#268bd2">$AZURE_SERVICE_OPERATOR_NAMESPACE</span> <span style="color:#cb4b16">\
</span><span style="color:#cb4b16"></span>--set <span style="color:#268bd2">azureSubscriptionID</span><span style="color:#719e07">=</span><span style="color:#268bd2">$AZURE_SUBSCRIPTION_ID</span> <span style="color:#cb4b16">\
</span><span style="color:#cb4b16"></span>--set <span style="color:#268bd2">azureTenantID</span><span style="color:#719e07">=</span><span style="color:#268bd2">$AZURE_TENANT_ID</span> <span style="color:#cb4b16">\
</span><span style="color:#cb4b16"></span>--set <span style="color:#268bd2">azureClientID</span><span style="color:#719e07">=</span><span style="color:#268bd2">$AZURE_CLIENT_ID</span> <span style="color:#cb4b16">\
</span><span style="color:#cb4b16"></span>--set <span style="color:#268bd2">azureClientSecret</span><span style="color:#719e07">=</span><span style="color:#268bd2">$AZURE_CLIENT_SECRET</span>
</code></pre></div><p>Before you proceed, wait for the Azure Service Operator <code>Pod</code> to startup</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get pods -n <span style="color:#268bd2">$AZURE_SERVICE_OPERATOR_NAMESPACE</span>

NAME                                              READY   STATUS    RESTARTS   AGE
azureoperator-controller-manager-68f44fd4-cm6wl   2/2     Running   <span style="color:#2aa198">0</span>          6m
</code></pre></div><h2 id="setup-azure-event-hubs-components">Setup Azure Event Hubs components&hellip;</h2>
<p>Start by cloning the repo:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone https://github.com/abhirockzz/eventhubs-using-aso-on-k8s
<span style="color:#b58900">cd</span> eventhubs-using-aso-on-k8s
</code></pre></div><p>Create an <a href="https://docs.microsoft.com/azure/azure-resource-manager/management/overview?WT.mc_id=devto-blog-abhishgu#resource-groups">Azure Resource Group</a></p>
<blockquote>
<p>I have used the <code>southeastasia</code> location. Please update <code>eh-resource-group.yaml</code> if you need to use a different one</p>
</blockquote>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f deploy/eh-resource-group.yaml

//confirm that its created
kubectl get resourcegroups/eh-aso-rg
</code></pre></div><p>Create <a href="https://docs.microsoft.com/azure/event-hubs/event-hubs-features?WT.mc_id=devto-blog-abhishgu#namespace">Event Hubs namespace</a></p>
<blockquote>
<p>I have used the <code>southeastasia</code> location. Please update <code>eh-namespace.yaml</code> if you need to use a different one</p>
</blockquote>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f deploy/eh-namespace.yaml

//wait <span style="color:#719e07">for</span> creation
kubectl get eventhubnamespaces -w
</code></pre></div><p>Once done, you should see this:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">NAME        PROVISIONED   MESSAGE
eh-aso-ns   <span style="color:#b58900">true</span>          successfully provisioned
</code></pre></div><p>You can get details with <code>kubectl describe eventhubnamespaces</code> and also double-check using <a href="https://docs.microsoft.com/cli/azure/eventhubs/namespace?view=azure-cli-latest&amp;WT.mc_id=devto-blog-abhishgu#az-eventhubs-namespace-show">az eventhubs namespace show</a></p>
<p>The namespace is ready, we can now create an Event Hub</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl apply -f deploy/eh-hub.yaml

kubectl get eventhubs/eh-aso-hub

//once done...
NAME        PROVISIONED   MESSAGE
eh-aso-hub  true          successfully provisioned
</code></pre></div><p>You can get details with <code>kubectl describe eventhub</code> and also double-check using <a href="https://docs.microsoft.com/cli/azure/eventhubs/eventhub?view=azure-cli-latest&amp;WT.mc_id=devto-blog-abhishgu#az-eventhubs-eventhub-show">az eventhubs eventhub show</a></p>
<p>As a final step, create the consumer group</p>
<blockquote>
<p>This is addition to the default consumer group (appropriately named <code>$Default</code>)</p>
</blockquote>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl apply -f deploy/eh-consumer-group.yaml

kubectl get consumergroups/eh-aso-cg

NAME        PROVISIONED   MESSAGE
eh-aso-cg  true          successfully provisioned
</code></pre></div><p>You can get details with <code>kubectl describe consumergroup</code> and also double-check using <a href="https://docs.microsoft.com/cli/azure/eventhubs/eventhub/consumer-group?view=azure-cli-latest&amp;WT.mc_id=devto-blog-abhishgu#az-eventhubs-eventhub-consumer-group-show"> eazventhubs eventhub consumer-group show</a></p>
<h2 id="whats-next">What&rsquo;s next?</h2>
<p>Let&rsquo;s make use of what we just setup! We&rsquo;ll deploy a pair of producer and consumer apps to Kubernetes that will send and receive messages from Event Hubs respectively. Both these client apps are written in <a href="https://golang.org/">Go</a> and use the <a href="https://github.com/Shopify/sarama/">Sarama library for Kafka</a>. I am not going to dive into the details since they are relatively straightforward</p>
<p>Deploy the consumer app:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f deploy/consumer.yaml

//wait <span style="color:#719e07">for</span> it to start
kubectl get pods -l<span style="color:#719e07">=</span><span style="color:#268bd2">app</span><span style="color:#719e07">=</span>eh-consumer -w
</code></pre></div><p>Keep a track of the logs for the consumer app:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl logs -f <span style="color:#719e07">$(</span>kubectl get pods -l<span style="color:#719e07">=</span><span style="color:#268bd2">app</span><span style="color:#719e07">=</span>eh-consumer --output<span style="color:#719e07">=</span><span style="color:#268bd2">jsonpath</span><span style="color:#719e07">={</span>.items..metadata.name<span style="color:#719e07">}</span><span style="color:#719e07">)</span>
</code></pre></div><p>You should see something similar to:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Event Hubs broker <span style="color:#719e07">[</span>eh-aso-ns.servicebus.windows.net:9093<span style="color:#719e07">]</span>
Sarama client consumer group ID eh-aso-cg
new consumer group created
Event Hubs topic eh-aso-hub
Waiting <span style="color:#719e07">for</span> program to <span style="color:#b58900">exit</span>
Partition allocation - map<span style="color:#719e07">[</span>eh-aso-hub:<span style="color:#719e07">[</span><span style="color:#2aa198">0</span> <span style="color:#2aa198">1</span> 2<span style="color:#719e07">]]</span>
</code></pre></div><p>Using another terminal, deploy the producer app:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f deploy/producer.yaml
</code></pre></div><p>Once the producer app is up and running, the consumer should kick in, start consumer the messages and print them to the console. So you&rsquo;ll see logs similar to this:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">...
Message topic:<span style="color:#2aa198">&#34;eh-aso-hub&#34;</span> partition:0 offset:6
Message content value-2020-07-06 15:37:06.116674866 +0000 UTC <span style="color:#268bd2">m</span><span style="color:#719e07">=</span>+67.450171692
Message topic:<span style="color:#2aa198">&#34;eh-aso-hub&#34;</span> partition:0 offset:7
Message content value-2020-07-06 15:37:09.133115988 +0000 UTC <span style="color:#268bd2">m</span><span style="color:#719e07">=</span>+70.466612714
Message topic:<span style="color:#2aa198">&#34;eh-aso-hub&#34;</span> partition:0 offset:8
Message content value-2020-07-06 15:37:12.149068005 +0000 UTC <span style="color:#268bd2">m</span><span style="color:#719e07">=</span>+73.482564831
...
</code></pre></div><blockquote>
<p>In case you want to check producer logs as well: <code>kubectl logs -f $(kubectl get pods -l=app=eh-producer --output=jsonpath={.items..metadata.name})</code></p>
</blockquote>
<p>Alright, it worked!</p>
<ul>
<li>We created an Event Hubs namespace, Event Hub along and a consumer group.. all using <code>kubectl</code> (and YAMLs of course)</li>
<li>Deployed a simple producer and consumer for testing</li>
</ul>
<h2 id="but-what-just-happened-">But, what just happened &hellip;?</h2>
<p>&hellip; how did the consumer and producer apps connect to Event Hubs without connection info, credentials etc.?</p>
<p><img src="https://media.giphy.com/media/xTiQygY6HW1GjoYKFq/giphy.gif" alt=""></p>
<p>Notice this part of Event Hub manifest (<code>eh-hub.yaml</code> file):</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">...
<span style="color:#268bd2">spec</span>:
  <span style="color:#268bd2">secretName</span>: eh-secret
  <span style="color:#268bd2">location</span>: southeastasia
  <span style="color:#268bd2">resourceGroup</span>: eh-aso-rg
...
</code></pre></div><p><code>secretName: eh-secret</code> ensured that a Kubernetes <code>Secret</code> was created with the required connectivity details including  connection strings (primary, secondary), keys (primary, secondary), along with the basic info such as Event Hubs namespace and hub name.</p>
<p>The producer and consumer <code>Deployment</code>s were simply able to refer to this. Take a look at this snippet from the consumer app <code>Deployment</code></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">...
      <span style="color:#268bd2">containers</span>:
        - <span style="color:#268bd2">name</span>: eh-consumer
          <span style="color:#268bd2">image</span>: abhirockzz/eh-kafka-consumer
          <span style="color:#268bd2">env</span>:
            - <span style="color:#268bd2">name</span>: EVENTHUBS_CONNECTION_STRING
              <span style="color:#268bd2">valueFrom</span>:
                <span style="color:#268bd2">secretKeyRef</span>:
                  <span style="color:#268bd2">name</span>: eh-secret
                  <span style="color:#268bd2">key</span>: primaryConnectionString
            - <span style="color:#268bd2">name</span>: EVENTHUBS_NAMESPACE
              <span style="color:#268bd2">valueFrom</span>:
                <span style="color:#268bd2">secretKeyRef</span>:
                  <span style="color:#268bd2">name</span>: eh-secret
                  <span style="color:#268bd2">key</span>: eventhubNamespace
            - <span style="color:#268bd2">name</span>: EVENTHUBS_BROKER
              <span style="color:#268bd2">value</span>: $(EVENTHUBS_NAMESPACE).servicebus.windows.net:9093
            - <span style="color:#268bd2">name</span>: EVENTHUBS_TOPIC
              <span style="color:#268bd2">valueFrom</span>:
                <span style="color:#268bd2">secretKeyRef</span>:
                  <span style="color:#268bd2">name</span>: eh-secret
                  <span style="color:#268bd2">key</span>: eventhubName
            - <span style="color:#268bd2">name</span>: EVENTHUBS_CONSUMER_GROUPID
              <span style="color:#268bd2">value</span>: eh-aso-cg
...
</code></pre></div><p>The app uses env vars <code>EVENTHUBS_CONNECTION_STRING</code>, <code>EVENTHUBS_NAMESPACE</code> and <code>EVENTHUBS_TOPIC</code> whose values were sourced from the Secret (<code>eh-secret</code>). The value for <code>EVENTHUBS_CONSUMER_GROUPID</code> is hardcoded to <code>eh-aso-cg</code> which was the name of the consumer group specified in <code>eh-consumer-group.yaml</code>.</p>
<h2 id="clean-up">Clean up</h2>
<p>To remove all the resources including Event Hubs and the client apps, simply use <code>kubectl delete -f deploy</code></p>
<h2 id="conclusion">Conclusion</h2>
<p>Azure Service Operator provides a layer of abstraction on top Azure specific primitives. It allows you to manage Azure resources and also provide ways to connect to them using other applications deployed in the same Kubernetes cluster.</p>
<p>I covered Azure Event Hubs as an example, but as I mentioned earlier, Azure Service Operator also supports other services too. Head over to <a href="https://github.com/Azure/azure-service-operator">the GitHub repo</a> and give them a try!</p>

		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/abhirockzz.github.io/tags/azure-event-hubs">azure event hubs</a></li>
								
								<li><a href="/abhirockzz.github.io/tags/kubernetes">kubernetes</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> Â© Abhishek Gupta, 2021 |  <a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-54762029-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script>feather.replace()</script>
</body>
</html>
