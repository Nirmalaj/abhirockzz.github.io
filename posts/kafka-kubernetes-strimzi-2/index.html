<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Kafka on Kubernetes, the Strimzi way! (Part 2) - Abhishek&#39;s blog (work in progress)</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Kafka on Kubernetes, the Strimzi way! (Part 2)" />
<meta property="og:description" content="Welcome to part two of this blog series!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="abhirockzz.github.io/posts/kafka-kubernetes-strimzi-2/" />
<meta property="article:published_time" content="2020-06-17T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-06-17T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kafka on Kubernetes, the Strimzi way! (Part 2)"/>
<meta name="twitter:description" content="Welcome to part two of this blog series!"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="abhirockzz.github.iocss/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="abhirockzz.github.iocss/main.css" />
	<link rel="stylesheet" type="text/css" href="abhirockzz.github.iocss/custom.css" />
	<link rel="stylesheet" type="text/css" href="abhirockzz.github.iocss/dark.css" media="(prefers-color-scheme: dark)" />
	<link rel="stylesheet" type="text/css" href="abhirockzz.github.iocss/custom-dark.css" media="(prefers-color-scheme: dark)" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<script src="abhirockzz.github.iojs/main.js"></script>
	<script src="abhirockzz.github.iojs/abc.js"></script>
	<script src="abhirockzz.github.iojs/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="abhirockzz.github.io">
	<h1 class="site-title"><a href="abhirockzz.github.io">Abhishek&#39;s blog (work in progress)</a></h1>
	<div class="site-description"><h2>Mostly about Kafka, Databases, Kubernetes and other open source stuff</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/abhirockzz/" title="Github"><i data-feather="github"></i></a><a href="https://twitter.com/abhi_tweeter" title="Twitter"><i data-feather="twitter"></i></a><a href="https://www.linkedin.com/in/abhirockzz/" title="LinkedIn"><i data-feather="linkedin"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="abhirockzz.github.io/">Home</a>
			</li>
			
			<li>
				<a href="abhirockzz.github.io/posts">All posts</a>
			</li>
			
			<li>
				<a href="abhirockzz.github.io/about">About</a>
			</li>
			
			<li>
				<a href="abhirockzz.github.io/books">Books</a>
			</li>
			
			<li>
				<a href="abhirockzz.github.io/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Kafka on Kubernetes, the Strimzi way! (Part 2)</h1>
			<div class="meta">Posted at &mdash; Jun 17, 2020</div>
		</div>

		<div class="markdown">
			<p>We kicked off the the <a href="posts/kafka-kubernetes-strimzi-1">first part of the series</a> by setting up a single node Kafka cluster which was accessible to only internal clients within the same Kubernetes cluster, had no encryption, authentication or authorization and used temporary persistence. We will keep iterating/improving on this during the course of this blog series.</p>
<p>This part will cover these topics:</p>
<ul>
<li>Expose Kafka cluster to external applications</li>
<li>Apply <code>TLS</code> encryption</li>
<li>Explore Kubernetes resources behind the scenes</li>
<li>Use Kafka CLI and Go client applications to test our cluster setup</li>
</ul>
<blockquote>
<p>The code is available on GitHub - <a href="https://github.com/abhirockzz/kafka-kubernetes-strimzi/">https://github.com/abhirockzz/kafka-kubernetes-strimzi/</a></p>
</blockquote>
<p><img src="https://media.giphy.com/media/CjmvTCZf2U3p09Cn0h/giphy-downsized.gif" alt=""></p>
<h2 id="what-do-i-need-to-try-this-out">What do I need to try this out?</h2>
<p><code>kubectl</code> - <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></p>
<p>I will be using <a href="https://docs.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=devto-blog-abhishgu">Azure Kubernetes Service (AKS)</a> to demonstrate the concepts, but by and large it is independent of the Kubernetes provider (e.g. feel free to use a local setup such as <code>minikube</code>). If you want to use <code>AKS</code>, all you need is a <a href="https://docs.microsoft.com/azure/?WT.mc_id=devto-blog-abhishgu">Microsoft Azure account</a> which you can <a href="https://azure.microsoft.com/free/?WT.mc_id=devto-blog-abhishgu">get for FREE</a> if you don&rsquo;t have one already.</p>
<blockquote>
<p>I will not be repeating some of the common sections (such as Installation/Setup for Helm, Strimzi, Azure Kubernetes Service as well as Strimzi overview) in this or subsequent part of this series and would request you to <a href="https://dev.to/azure/kafka-on-kubernetes-the-strimzi-way-part-1-57g7">refer to part one</a> for those details</p>
</blockquote>
<h2 id="lets-create-an-externally-accessible-kafka-cluster">Let&rsquo;s create an externally accessible Kafka cluster</h2>
<p>To achieve this, we just need to tweak the Strimzi <code>Kafka</code> resource a little bit. I am highlighting the key part below - <a href="https://github.com/abhirockzz/kafka-kubernetes-strimzi/raw/master/part-1/kafka.yaml">here is the original manifest from part 1</a></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#268bd2">spec</span>:
  <span style="color:#268bd2">kafka</span>:
    <span style="color:#268bd2">version</span>: <span style="color:#2aa198">2.4.0</span>
    <span style="color:#268bd2">replicas</span>: <span style="color:#2aa198">1</span>
    <span style="color:#268bd2">listeners</span>:
      <span style="color:#268bd2">plain</span>: {}
      <span style="color:#268bd2">external</span>:
        <span style="color:#268bd2">type</span>: loadbalancer
        <span style="color:#268bd2">tls</span>: <span style="color:#cb4b16">true</span>
</code></pre></div><p><strong>What changed?</strong></p>
<p>To make Kafka accessible to external client applications, we added an <code>external</code> listener of type <code>loadbalancer</code>. Since we will exposing our application to the public Internet, we need additional layers of protection such as transport level (<code>TLS/SSL</code> encryption) and application level security (authentication and authorization). In this part, we will just configure encryption and explore the other aspects in another blog. To configure end-to-end TLS encryption, we add <code>tls: true</code></p>
<blockquote>
<p><code>tls: true</code> config is actually used as a default, but I have added it explicitly for sake of clarity</p>
</blockquote>
<p>To create the cluster:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f https://github.com/abhirockzz/kafka-kubernetes-strimzi/raw/master/part-2/kafka.yaml
</code></pre></div><h3 id="kubernetes-magic">Kubernetes magic!</h3>
<p>The Strimzi Operator kicks into action and does all the heavy lifting for us:</p>
<ul>
<li>It creates a Kubernetes <a href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer"><code>LoadBalancer</code></a> Service..</li>
<li>.. and seeding the appropriate Kafka server configuration in a <code>ConfigMap</code></li>
</ul>
<p><img src="https://media.giphy.com/media/12NUbkX6p4xOO4/giphy.gif" alt=""></p>
<p>I will be highlighting the resources created corresponding to the external listener and TLS encryption. For a walk through of ALL the resources which are created as part of the Kafka cluster, <a href="https://dev.to/azure/kafka-on-kubernetes-the-strimzi-way-part-1-57g7">please refer to part 1</a></p>
<p>If you look for the <code>Service</code>s, you will see something similar to this:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get svc

my-kafka-cluster-kafka-0                    LoadBalancer   10.0.162.98    40.119.233.2    9094:31860/TCP               60s
my-kafka-cluster-kafka-bootstrap            ClusterIP      10.0.200.20    &lt;none&gt;          9091/TCP,9092/TCP            60s
my-kafka-cluster-kafka-brokers              ClusterIP      None           &lt;none&gt;          9091/TCP,9092/TCP            60s
my-kafka-cluster-kafka-external-bootstrap   LoadBalancer   10.0.122.211   20.44.239.202   9094:32267/TCP               60s
my-kafka-cluster-zookeeper-client           ClusterIP      10.0.137.33    &lt;none&gt;          2181/TCP                     82s
my-kafka-cluster-zookeeper-nodes            ClusterIP      None           &lt;none&gt;          2181/TCP,2888/TCP,3888/TCP   82s
</code></pre></div><p>Notice the <code>my-kafka-cluster-kafka-external-bootstrap</code> <code>Service</code> of the type <code>LoadBalancer</code>? Since I am using Azure Kubernetes Service, this is powered by an <a href="https://docs.microsoft.com/azure/load-balancer/load-balancer-overview?WT.mc_id=devto-blog-abhishgu">Azure Load Balancer</a> which has a public IP (<code>20.44.239.202</code> in this example) and exposes Kafka to external clients over port <code>9094</code>. You should be able to locate it using the Azure CLI (or the Azure portal if you prefer) by using the <a href="https://docs.microsoft.com/cli/azure/network/lb?view=azure-cli-latest&amp;WT.mc_id=devto-blog-abhishgu#az-network-lb-list"><code>az network lb list</code></a> command</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">AKS_RESOURCE_GROUP</span><span style="color:#719e07">=[</span>replace with resource group name<span style="color:#719e07">]</span>
<span style="color:#b58900">export</span> <span style="color:#268bd2">AKS_CLUSTER_NAME</span><span style="color:#719e07">=[</span>replace with AKS cluster name<span style="color:#719e07">]</span>
<span style="color:#b58900">export</span> <span style="color:#268bd2">AKS_LOCATION</span><span style="color:#719e07">=[</span>replace with region e.g. southeastasia<span style="color:#719e07">]</span>

az network lb list -g MC_<span style="color:#2aa198">${</span><span style="color:#268bd2">AKS_RESOURCE_GROUP</span><span style="color:#2aa198">}</span>_<span style="color:#2aa198">${</span><span style="color:#268bd2">AKS_CLUSTER_NAME</span><span style="color:#2aa198">}</span>_<span style="color:#2aa198">${</span><span style="color:#268bd2">AKS_LOCATION</span><span style="color:#2aa198">}</span>
</code></pre></div><p><strong>What about the encryption part?</strong></p>
<p>To figure that out, let&rsquo;s introspect the Kafka server configuration:</p>
<blockquote>
<p>As explained in the <a href="https://dev.to/azure/kafka-on-kubernetes-the-strimzi-way-part-1-57g7">previous blog</a>, this is stored in a <code>ConfigMap</code></p>
</blockquote>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">CLUSTER_NAME</span><span style="color:#719e07">=</span>my-kafka-cluster
kubectl get configmap/<span style="color:#2aa198">${</span><span style="color:#268bd2">CLUSTER_NAME</span><span style="color:#2aa198">}</span>-kafka-config -o yaml
</code></pre></div><p>This is what the <code>Common listener configuration</code> in <code>server.config</code> reveals:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#268bd2">listeners</span><span style="color:#719e07">=</span>REPLICATION-9091://0.0.0.0:9091,PLAIN-9092://0.0.0.0:9092,EXTERNAL-9094://0.0.0.0:9094
advertised.listeners<span style="color:#719e07">=</span>REPLICATION-9091://my-kafka-cluster-kafka-<span style="color:#2aa198">${</span><span style="color:#268bd2">STRIMZI_BROKER_ID</span><span style="color:#2aa198">}</span>.my-kafka-cluster-kafka-brokers.default.svc:9091,PLAIN-9092://my-kafka-cluster-kafka-<span style="color:#2aa198">${</span><span style="color:#268bd2">STRIMZI_BROKER_ID</span><span style="color:#2aa198">}</span>.my-kafka-cluster-kafka-brokers.default.svc:9092,EXTERNAL-9094://<span style="color:#2aa198">${</span><span style="color:#268bd2">STRIMZI_EXTERNAL_9094_ADVERTISED_HOSTNAME</span><span style="color:#2aa198">}</span>:<span style="color:#2aa198">${</span><span style="color:#268bd2">STRIMZI_EXTERNAL_9094_ADVERTISED_PORT</span><span style="color:#2aa198">}</span>
listener.security.protocol.map<span style="color:#719e07">=</span>REPLICATION-9091:SSL,PLAIN-9092:PLAINTEXT,EXTERNAL-9094:SSL
</code></pre></div><p>Notice that in addition to inter-broker replication (over port <code>9091</code>) and un-encrypted internal (within Kubernetes cluster) client access over non <code>TLS</code> port <code>9092</code>, appropriate listener config has been added for TLS encrypted access over port <code>9094</code></p>
<h2 id="the-moment-of-truth">The moment of truth&hellip;.</h2>
<p>To confirm, let&rsquo;s try out a couple of client applications which will communicate with our freshly minted Kafka cluster on Kubernetes! We will produce and consume messages using the following:</p>
<ul>
<li>Kafka CLI (console) producer and consumer</li>
<li>Go application (using the <a href="https://github.com/confluentinc/confluent-kafka-go">Confluent Kafka Go client</a>)</li>
</ul>
<p>Communication to our Kafka cluster has to be encrypted (non TLS client connections will be rejected). <code>TLS/SSL</code> implicitly implies one way authentication, where the client validates the Kafka broker identity. In order to do this, client applications need to trust the cluster CA certificate. Remember that the cluster CA certificate is stored in a Kubernetes <code>Secret</code> (refer to <a href="https://dev.to/azure/kafka-on-kubernetes-the-strimzi-way-part-1-57g7">details in part 1</a>). By default, these are auto-generated by Strimzi, but you can provide your own certificates as well (refer <a href="https://strimzi.io/docs/operators/master/using.html#kafka-listener-certificates-str">https://strimzi.io/docs/operators/master/using.html#kafka-listener-certificates-str</a>)</p>
<p>Start by extracting the cluster CA certificate and password:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">CLUSTER_NAME</span><span style="color:#719e07">=</span>my-kafka-cluster

kubectl get secret <span style="color:#268bd2">$CLUSTER_NAME</span>-cluster-ca-cert -o <span style="color:#268bd2">jsonpath</span><span style="color:#719e07">=</span><span style="color:#2aa198">&#39;{.data.ca\.crt}&#39;</span> | base64 --decode &gt; ca.crt
kubectl get secret <span style="color:#268bd2">$CLUSTER_NAME</span>-cluster-ca-cert -o <span style="color:#268bd2">jsonpath</span><span style="color:#719e07">=</span><span style="color:#2aa198">&#39;{.data.ca\.password}&#39;</span> | base64 --decode &gt; ca.password
</code></pre></div><blockquote>
<p>You should have two files: <code>ca.crt</code> and <code>ca.password</code>. Feel free to check out their contents</p>
</blockquote>
<p>While some Kafka clients (e.g. Confluent Go client) use the CA certificate directly, others (e.g. Java client, Kafka CLI etc.) require access to the CA certificate via a <code>truststore</code>. I am using the built-in <code>truststore</code> which comes in with a JDK (Java) installation - but this is just for convenience and you&rsquo;re free to use other options (such as creating your own)</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">CERT_FILE_PATH</span><span style="color:#719e07">=</span>ca.crt
<span style="color:#b58900">export</span> <span style="color:#268bd2">CERT_PASSWORD_FILE_PATH</span><span style="color:#719e07">=</span>ca.password

<span style="color:#586e75"># replace this with the path to your truststore</span>

<span style="color:#b58900">export</span> <span style="color:#268bd2">KEYSTORE_LOCATION</span><span style="color:#719e07">=</span>/Library/Java/JavaVirtualMachines/jdk1.8.0_221.jdk/Contents/Home/jre/lib/security/cacerts
<span style="color:#b58900">export</span> <span style="color:#268bd2">PASSWORD</span><span style="color:#719e07">=</span><span style="color:#586e75">`</span>cat <span style="color:#268bd2">$CERT_PASSWORD_FILE_PATH</span><span style="color:#586e75">`</span>
<span style="color:#b58900">export</span> <span style="color:#268bd2">CA_CERT_ALIAS</span><span style="color:#719e07">=</span>strimzi-kafka-cert

<span style="color:#586e75"># you will prompted for the truststore password. for JDK truststore, the default password is &#34;changeit&#34;</span>
<span style="color:#586e75"># Type yes in response to the &#39;Trust this certificate? [no]:&#39; prompt</span>

sudo keytool -importcert -alias <span style="color:#268bd2">$CA_CERT_ALIAS</span> -file <span style="color:#268bd2">$CERT_FILE_PATH</span> -keystore <span style="color:#268bd2">$KEYSTORE_LOCATION</span> -keypass <span style="color:#268bd2">$PASSWORD</span>

sudo keytool -list -alias <span style="color:#268bd2">$CA_CERT_ALIAS</span> -keystore <span style="color:#268bd2">$KEYSTORE_LOCATION</span>
</code></pre></div><p>That&rsquo;s it for the base setup - you are ready to try out the Kafka CLI client!</p>
<blockquote>
<p>Please note that the configuration steps for the Kafka CLI as detailed below will also work for the Java clients as well - give it a try!</p>
</blockquote>
<p>Extract the <code>LoadBalancer</code> public IP for Kafka cluster</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">KAFKA_CLUSTER_NAME</span><span style="color:#719e07">=</span>my-kafka-cluster

kubectl get service/<span style="color:#2aa198">${</span><span style="color:#268bd2">KAFKA_CLUSTER_NAME</span><span style="color:#2aa198">}</span>-kafka-external-bootstrap --output<span style="color:#719e07">=</span><span style="color:#268bd2">jsonpath</span><span style="color:#719e07">={</span>.status.loadBalancer.ingress<span style="color:#719e07">[</span>0<span style="color:#719e07">]</span>.ip<span style="color:#719e07">}</span>
</code></pre></div><p>Create a file called <code>client-ssl.properties</code> with the following contents:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bootstrap.servers<span style="color:#719e07">=[</span>LOADBALANCER_PUBLIC_IP<span style="color:#719e07">]</span>:9094
security.protocol<span style="color:#719e07">=</span>SSL
ssl.truststore.location<span style="color:#719e07">=[</span>TRUSTSTORE_LOCATION<span style="color:#719e07">]</span>
//for JDK truststore, the default password is <span style="color:#2aa198">&#34;changeit&#34;</span>
ssl.truststore.password<span style="color:#719e07">=</span>changeit
</code></pre></div><p>To use the Kafka CLI, download <code>Kafka</code> if you don&rsquo;t have it already - <a href="https://kafka.apache.org/downloads">https://kafka.apache.org/downloads</a></p>
<p>All you need to do is use the <code>kafka-console-producer</code> and <code>kafka-console-consumer</code> by pointing it to the <code>client-ssl.properties</code> file you just created</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b58900">export</span> <span style="color:#268bd2">KAFKA_HOME</span><span style="color:#719e07">=[</span>replace with Kafka installation path<span style="color:#719e07">]</span> e.g. /Users/foobar/kafka_2.12-2.3.0
<span style="color:#b58900">export</span> <span style="color:#268bd2">LOADBALANCER_PUBLIC_IP</span><span style="color:#719e07">=[</span>replace with public IP of Load Balancer<span style="color:#719e07">]</span>
<span style="color:#b58900">export</span> <span style="color:#268bd2">TOPIC_NAME</span><span style="color:#719e07">=</span>test-strimzi-topic

<span style="color:#586e75"># on a terminal, start producer and send a few messages</span>
<span style="color:#268bd2">$KAFKA_HOME</span>/bin/kafka-console-producer.sh --broker-list <span style="color:#268bd2">$LOADBALANCER_PUBLIC_IP</span>:9094 --topic <span style="color:#268bd2">$TOPIC_NAME</span> --producer.config client-ssl.properties

<span style="color:#586e75"># on another terminal, start consumer</span>
<span style="color:#268bd2">$KAFKA_HOME</span>/bin/kafka-console-consumer.sh --bootstrap-server <span style="color:#268bd2">$LOADBALANCER_PUBLIC_IP</span>:9094 --topic <span style="color:#268bd2">$TOPIC_NAME</span> --consumer.config client-ssl.properties --from-beginning
</code></pre></div><p>You should see producer and consumer working in tandem. Great!</p>
<blockquote>
<p>If you face SSL Handshake errors, please check whether the CA cert has been correctly imported along with its correct password. If the Kafka cluster is not reachable, ensure you are using the right value for the public IP</p>
</blockquote>
<p>Now, let&rsquo;s try a programmatic client. Since the Java client behavior (required config properties) are same as the CLI, I am using a Go client to try something different. Don&rsquo;t worry, if you are not a Go programmer, it should be easy to follow along - I will not walk through the entire program, just the part where we create the connection related configuration.</p>
<p>Here is the snippet:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    bootstrapServers = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;KAFKA_BOOTSTRAP_SERVERS&#34;</span>)
    caLocation = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;CA_CERT_LOCATION&#34;</span>)
    topic = os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;KAFKA_TOPIC&#34;</span>)

    config <span style="color:#719e07">:=</span> <span style="color:#719e07">&amp;</span>kafka.ConfigMap{<span style="color:#2aa198">&#34;bootstrap.servers&#34;</span>: bootstrapServers, <span style="color:#2aa198">&#34;security.protocol&#34;</span>: <span style="color:#2aa198">&#34;SSL&#34;</span>, <span style="color:#2aa198">&#34;ssl.ca.location&#34;</span>: caLocation}
</code></pre></div><p>Notice that the <code>bootstrap.servers</code> and <code>security.protocol</code> are the same as ones you used in the Kafka CLI client (same for Java as well). The only difference is that <code>ssl.ca.location</code> is used to point to the CA certificate directly as opposed to a <code>truststore</code></p>
<p>If you have <code>Go</code> installed, you can try it out. Clone the Git repo&hellip;</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone https://github.com/abhirockzz/kafka-kubernetes-strimzi
<span style="color:#b58900">cd</span> part-2/go-client-app
</code></pre></div><p>.. and run the program:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">export KAFKA_BOOTSTRAP_SERVERS=[replace with loadbalancer_ip:<span style="color:#2aa198">9094</span>] e.g. <span style="color:#2aa198">42.42.424.424</span>:<span style="color:#2aa198">9094</span>
export CA_CERT_LOCATION=[replace with path to ca.crt file which you downloaded]
export KAFKA_TOPIC=test<span style="color:#719e07">-</span>strimzi<span style="color:#719e07">-</span>topic

<span style="color:#719e07">go</span> run kafka<span style="color:#719e07">-</span>client.<span style="color:#719e07">go</span>
</code></pre></div><p>You should see logs similar to this and confirm that messages are being produced and consumed</p>
<blockquote>
<p>press <code>ctrl+c</code> to exit the app</p>
</blockquote>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">started consumer
started producer delivery goroutine
started producer goroutine
delivered messaged test-strimzi-topic<span style="color:#719e07">[</span>0<span style="color:#719e07">]</span>@122
delivered messaged test-strimzi-topic<span style="color:#719e07">[</span>0<span style="color:#719e07">]</span>@123
delivered messaged test-strimzi-topic<span style="color:#719e07">[</span>0<span style="color:#719e07">]</span>@124
received message from test-strimzi-topic<span style="color:#719e07">[</span>0<span style="color:#719e07">]</span>@122: value-2020-06-08 16:23:05.913303 +0530 IST <span style="color:#268bd2">m</span><span style="color:#719e07">=</span>+0.020529419
received message from test-strimzi-topic<span style="color:#719e07">[</span>0<span style="color:#719e07">]</span>@123: value-2020-06-08 16:23:07.915252 +0530 IST <span style="color:#268bd2">m</span><span style="color:#719e07">=</span>+2.022455867
received message from test-strimzi-topic<span style="color:#719e07">[</span>0<span style="color:#719e07">]</span>@124: value-2020-06-08 16:23:09.915875 +0530 IST <span style="color:#268bd2">m</span><span style="color:#719e07">=</span>+4.023055601
received message from test-strimzi-topic<span style="color:#719e07">[</span>0<span style="color:#719e07">]</span>@125: value-2020-06-08 16:23:11.915977 +0530 IST <span style="color:#268bd2">m</span><span style="color:#719e07">=</span>+6.023134961
....
</code></pre></div><h2 id="thats-all-for-now-but-there-is-more-to-come">That&rsquo;s all for now, but there is more to come!</h2>
<p><img src="https://media.giphy.com/media/26u4lOMA8JKSnL9Uk/giphy.gif" alt=""></p>
<p>So we made some progress! We now have a Kafka cluster on Kubernetes which is publicly accessible but is (partially) secure thanks to TLS encryption. We also did some sanity testing using not one, but two (different) client applications. In the next part, we&rsquo;ll improve this further&hellip; stay tuned!</p>

		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/abhirockzz.github.io/tags/kafka">kafka</a></li>
								
								<li><a href="/abhirockzz.github.io/tags/kubernetes">kubernetes</a></li>
								
								<li><a href="/abhirockzz.github.io/tags/strimzi">strimzi</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © Copyright notice |  <a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-54762029-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script>feather.replace()</script>
</body>
</html>
