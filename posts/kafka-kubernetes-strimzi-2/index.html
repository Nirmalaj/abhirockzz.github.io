<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Kafka on Kubernetes, the Strimzi way! (Part 2) - Data Foo</title>
  <meta name="description" content="Welcome to part two of this blog series!">
  <meta name="author" content="Abhishek Gupta"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Data Foo",
    
    "url": "https:\/\/abhirockzz.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/abhirockzz.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/abhirockzz.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/abhirockzz.github.io\/posts\/kafka-kubernetes-strimzi-2\/",
          "name": "Kafka on kubernetes, the strimzi way! ( part 2)"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Abhishek Gupta"
  },
  "headline": "Kafka on Kubernetes, the Strimzi way! (Part 2)",
  "description" : "Welcome to part two of this blog series!",
  "inLanguage" : "en",
  "wordCount":  1469 ,
  "datePublished" : "2020-06-17T00:00:00",
  "dateModified" : "2020-06-17T00:00:00",
  "image" : "https:\/\/abhirockzz.github.io\/icon.jpg",
  "keywords" : [ "kafka, kubernetes, strimzi" ],
  "mainEntityOfPage" : "https:\/\/abhirockzz.github.io\/posts\/kafka-kubernetes-strimzi-2\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/abhirockzz.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/abhirockzz.github.io\/icon.jpg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Kafka on Kubernetes, the Strimzi way! (Part 2)" />
<meta property="og:description" content="Welcome to part two of this blog series!">
<meta property="og:image" content="https://abhirockzz.github.io/icon.jpg" />
<meta property="og:url" content="https://abhirockzz.github.io/posts/kafka-kubernetes-strimzi-2/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Data Foo" />

  <meta name="twitter:title" content="Kafka on Kubernetes, the Strimzi way! (Part 2)" />
  <meta name="twitter:description" content="Welcome to part two of this blog series!">
  <meta name="twitter:image" content="https://abhirockzz.github.io/icon.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@abhi_tweeter" />
  <meta name="twitter:creator" content="@abhi_tweeter" />
  <link href='https://abhirockzz.github.io/icons/myicon.png' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.80.0" />
  <link rel="alternate" href="https://abhirockzz.github.io/index.xml" type="application/rss+xml" title="Data Foo"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://abhirockzz.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://abhirockzz.github.io/css/syntax.css" /><link rel="stylesheet" href="https://abhirockzz.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-54762029-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://abhirockzz.github.io/">Data Foo</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/about">About</a>
            </li>
          
        
          
            <li>
              <a title="Books" href="/books">Books</a>
            </li>
          
        
          
            <li>
              <a title="Presentations" href="/presentations">Presentations</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Data Foo" href="https://abhirockzz.github.io/">
            <img class="avatar-img" src="https://abhirockzz.github.io/icon.jpg" alt="Data Foo" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="posts-heading">
              
                <h1>Kafka on Kubernetes, the Strimzi way! (Part 2)</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>We kicked off the the <a href="posts/kafka-kubernetes-strimzi-1">first part of the series</a> by setting up a single node Kafka cluster which was accessible to only internal clients within the same Kubernetes cluster, had no encryption, authentication or authorization and used temporary persistence. We will keep iterating/improving on this during the course of this blog series.</p>
<p>This part will cover these topics:</p>
<ul>
<li>Expose Kafka cluster to external applications</li>
<li>Apply <code>TLS</code> encryption</li>
<li>Explore Kubernetes resources behind the scenes</li>
<li>Use Kafka CLI and Go client applications to test our cluster setup</li>
</ul>
<blockquote>
<p>The code is available on GitHub - <a href="https://github.com/abhirockzz/kafka-kubernetes-strimzi/">https://github.com/abhirockzz/kafka-kubernetes-strimzi/</a></p>
</blockquote>
<p><img src="https://media.giphy.com/media/CjmvTCZf2U3p09Cn0h/giphy-downsized.gif" alt=""></p>
<h2 id="what-do-i-need-to-try-this-out">What do I need to try this out?</h2>
<p><code>kubectl</code> - <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></p>
<p>I will be using <a href="https://docs.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=devto-blog-abhishgu">Azure Kubernetes Service (AKS)</a> to demonstrate the concepts, but by and large it is independent of the Kubernetes provider (e.g. feel free to use a local setup such as <code>minikube</code>). If you want to use <code>AKS</code>, all you need is a <a href="https://docs.microsoft.com/azure/?WT.mc_id=devto-blog-abhishgu">Microsoft Azure account</a> which you can <a href="https://azure.microsoft.com/free/?WT.mc_id=devto-blog-abhishgu">get for FREE</a> if you don&rsquo;t have one already.</p>
<blockquote>
<p>I will not be repeating some of the common sections (such as Installation/Setup for Helm, Strimzi, Azure Kubernetes Service as well as Strimzi overview) in this or subsequent part of this series and would request you to <a href="https://dev.to/azure/kafka-on-kubernetes-the-strimzi-way-part-1-57g7">refer to part one</a> for those details</p>
</blockquote>
<h2 id="lets-create-an-externally-accessible-kafka-cluster">Let&rsquo;s create an externally accessible Kafka cluster</h2>
<p>To achieve this, we just need to tweak the Strimzi <code>Kafka</code> resource a little bit. I am highlighting the key part below - <a href="https://github.com/abhirockzz/kafka-kubernetes-strimzi/raw/master/part-1/kafka.yaml">here is the original manifest from part 1</a></p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">kafka</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">2.4.0</span><span class="w">
</span><span class="w">    </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">    </span><span class="nt">listeners</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">plain</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">      </span><span class="nt">external</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">loadbalancer</span><span class="w">
</span><span class="w">        </span><span class="nt">tls</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></code></pre></div><p><strong>What changed?</strong></p>
<p>To make Kafka accessible to external client applications, we added an <code>external</code> listener of type <code>loadbalancer</code>. Since we will exposing our application to the public Internet, we need additional layers of protection such as transport level (<code>TLS/SSL</code> encryption) and application level security (authentication and authorization). In this part, we will just configure encryption and explore the other aspects in another blog. To configure end-to-end TLS encryption, we add <code>tls: true</code></p>
<blockquote>
<p><code>tls: true</code> config is actually used as a default, but I have added it explicitly for sake of clarity</p>
</blockquote>
<p>To create the cluster:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">kubectl apply -f https://github.com/abhirockzz/kafka-kubernetes-strimzi/raw/master/part-2/kafka.yaml
</code></pre></div><h3 id="kubernetes-magic">Kubernetes magic!</h3>
<p>The Strimzi Operator kicks into action and does all the heavy lifting for us:</p>
<ul>
<li>It creates a Kubernetes <a href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer"><code>LoadBalancer</code></a> Service..</li>
<li>.. and seeding the appropriate Kafka server configuration in a <code>ConfigMap</code></li>
</ul>
<p><img src="https://media.giphy.com/media/12NUbkX6p4xOO4/giphy.gif" alt=""></p>
<p>I will be highlighting the resources created corresponding to the external listener and TLS encryption. For a walk through of ALL the resources which are created as part of the Kafka cluster, <a href="https://dev.to/azure/kafka-on-kubernetes-the-strimzi-way-part-1-57g7">please refer to part 1</a></p>
<p>If you look for the <code>Service</code>s, you will see something similar to this:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">kubectl get svc

my-kafka-cluster-kafka-0                    LoadBalancer   10.0.162.98    40.119.233.2    9094:31860/TCP               60s
my-kafka-cluster-kafka-bootstrap            ClusterIP      10.0.200.20    &lt;none&gt;          9091/TCP,9092/TCP            60s
my-kafka-cluster-kafka-brokers              ClusterIP      None           &lt;none&gt;          9091/TCP,9092/TCP            60s
my-kafka-cluster-kafka-external-bootstrap   LoadBalancer   10.0.122.211   20.44.239.202   9094:32267/TCP               60s
my-kafka-cluster-zookeeper-client           ClusterIP      10.0.137.33    &lt;none&gt;          2181/TCP                     82s
my-kafka-cluster-zookeeper-nodes            ClusterIP      None           &lt;none&gt;          2181/TCP,2888/TCP,3888/TCP   82s
</code></pre></div><p>Notice the <code>my-kafka-cluster-kafka-external-bootstrap</code> <code>Service</code> of the type <code>LoadBalancer</code>? Since I am using Azure Kubernetes Service, this is powered by an <a href="https://docs.microsoft.com/azure/load-balancer/load-balancer-overview?WT.mc_id=devto-blog-abhishgu">Azure Load Balancer</a> which has a public IP (<code>20.44.239.202</code> in this example) and exposes Kafka to external clients over port <code>9094</code>. You should be able to locate it using the Azure CLI (or the Azure portal if you prefer) by using the <a href="https://docs.microsoft.com/cli/azure/network/lb?view=azure-cli-latest&amp;WT.mc_id=devto-blog-abhishgu#az-network-lb-list"><code>az network lb list</code></a> command</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">AKS_RESOURCE_GROUP</span><span class="o">=[</span>replace with resource group name<span class="o">]</span>
<span class="nb">export</span> <span class="nv">AKS_CLUSTER_NAME</span><span class="o">=[</span>replace with AKS cluster name<span class="o">]</span>
<span class="nb">export</span> <span class="nv">AKS_LOCATION</span><span class="o">=[</span>replace with region e.g. southeastasia<span class="o">]</span>

az network lb list -g MC_<span class="si">${</span><span class="nv">AKS_RESOURCE_GROUP</span><span class="si">}</span>_<span class="si">${</span><span class="nv">AKS_CLUSTER_NAME</span><span class="si">}</span>_<span class="si">${</span><span class="nv">AKS_LOCATION</span><span class="si">}</span>
</code></pre></div><p><strong>What about the encryption part?</strong></p>
<p>To figure that out, let&rsquo;s introspect the Kafka server configuration:</p>
<blockquote>
<p>As explained in the <a href="https://dev.to/azure/kafka-on-kubernetes-the-strimzi-way-part-1-57g7">previous blog</a>, this is stored in a <code>ConfigMap</code></p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">CLUSTER_NAME</span><span class="o">=</span>my-kafka-cluster
kubectl get configmap/<span class="si">${</span><span class="nv">CLUSTER_NAME</span><span class="si">}</span>-kafka-config -o yaml
</code></pre></div><p>This is what the <code>Common listener configuration</code> in <code>server.config</code> reveals:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">listeners</span><span class="o">=</span>REPLICATION-9091://0.0.0.0:9091,PLAIN-9092://0.0.0.0:9092,EXTERNAL-9094://0.0.0.0:9094
advertised.listeners<span class="o">=</span>REPLICATION-9091://my-kafka-cluster-kafka-<span class="si">${</span><span class="nv">STRIMZI_BROKER_ID</span><span class="si">}</span>.my-kafka-cluster-kafka-brokers.default.svc:9091,PLAIN-9092://my-kafka-cluster-kafka-<span class="si">${</span><span class="nv">STRIMZI_BROKER_ID</span><span class="si">}</span>.my-kafka-cluster-kafka-brokers.default.svc:9092,EXTERNAL-9094://<span class="si">${</span><span class="nv">STRIMZI_EXTERNAL_9094_ADVERTISED_HOSTNAME</span><span class="si">}</span>:<span class="si">${</span><span class="nv">STRIMZI_EXTERNAL_9094_ADVERTISED_PORT</span><span class="si">}</span>
listener.security.protocol.map<span class="o">=</span>REPLICATION-9091:SSL,PLAIN-9092:PLAINTEXT,EXTERNAL-9094:SSL
</code></pre></div><p>Notice that in addition to inter-broker replication (over port <code>9091</code>) and un-encrypted internal (within Kubernetes cluster) client access over non <code>TLS</code> port <code>9092</code>, appropriate listener config has been added for TLS encrypted access over port <code>9094</code></p>
<h2 id="the-moment-of-truth">The moment of truth&hellip;.</h2>
<p>To confirm, let&rsquo;s try out a couple of client applications which will communicate with our freshly minted Kafka cluster on Kubernetes! We will produce and consume messages using the following:</p>
<ul>
<li>Kafka CLI (console) producer and consumer</li>
<li>Go application (using the <a href="https://github.com/confluentinc/confluent-kafka-go">Confluent Kafka Go client</a>)</li>
</ul>
<p>Communication to our Kafka cluster has to be encrypted (non TLS client connections will be rejected). <code>TLS/SSL</code> implicitly implies one way authentication, where the client validates the Kafka broker identity. In order to do this, client applications need to trust the cluster CA certificate. Remember that the cluster CA certificate is stored in a Kubernetes <code>Secret</code> (refer to <a href="https://dev.to/azure/kafka-on-kubernetes-the-strimzi-way-part-1-57g7">details in part 1</a>). By default, these are auto-generated by Strimzi, but you can provide your own certificates as well (refer <a href="https://strimzi.io/docs/operators/master/using.html#kafka-listener-certificates-str">https://strimzi.io/docs/operators/master/using.html#kafka-listener-certificates-str</a>)</p>
<p>Start by extracting the cluster CA certificate and password:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">CLUSTER_NAME</span><span class="o">=</span>my-kafka-cluster

kubectl get secret <span class="nv">$CLUSTER_NAME</span>-cluster-ca-cert -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data.ca\.crt}&#39;</span> <span class="p">|</span> base64 --decode &gt; ca.crt
kubectl get secret <span class="nv">$CLUSTER_NAME</span>-cluster-ca-cert -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data.ca\.password}&#39;</span> <span class="p">|</span> base64 --decode &gt; ca.password
</code></pre></div><blockquote>
<p>You should have two files: <code>ca.crt</code> and <code>ca.password</code>. Feel free to check out their contents</p>
</blockquote>
<p>While some Kafka clients (e.g. Confluent Go client) use the CA certificate directly, others (e.g. Java client, Kafka CLI etc.) require access to the CA certificate via a <code>truststore</code>. I am using the built-in <code>truststore</code> which comes in with a JDK (Java) installation - but this is just for convenience and you&rsquo;re free to use other options (such as creating your own)</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">CERT_FILE_PATH</span><span class="o">=</span>ca.crt
<span class="nb">export</span> <span class="nv">CERT_PASSWORD_FILE_PATH</span><span class="o">=</span>ca.password

<span class="c1"># replace this with the path to your truststore</span>

<span class="nb">export</span> <span class="nv">KEYSTORE_LOCATION</span><span class="o">=</span>/Library/Java/JavaVirtualMachines/jdk1.8.0_221.jdk/Contents/Home/jre/lib/security/cacerts
<span class="nb">export</span> <span class="nv">PASSWORD</span><span class="o">=</span><span class="sb">`</span>cat <span class="nv">$CERT_PASSWORD_FILE_PATH</span><span class="sb">`</span>
<span class="nb">export</span> <span class="nv">CA_CERT_ALIAS</span><span class="o">=</span>strimzi-kafka-cert

<span class="c1"># you will prompted for the truststore password. for JDK truststore, the default password is &#34;changeit&#34;</span>
<span class="c1"># Type yes in response to the &#39;Trust this certificate? [no]:&#39; prompt</span>

sudo keytool -importcert -alias <span class="nv">$CA_CERT_ALIAS</span> -file <span class="nv">$CERT_FILE_PATH</span> -keystore <span class="nv">$KEYSTORE_LOCATION</span> -keypass <span class="nv">$PASSWORD</span>

sudo keytool -list -alias <span class="nv">$CA_CERT_ALIAS</span> -keystore <span class="nv">$KEYSTORE_LOCATION</span>
</code></pre></div><p>That&rsquo;s it for the base setup - you are ready to try out the Kafka CLI client!</p>
<blockquote>
<p>Please note that the configuration steps for the Kafka CLI as detailed below will also work for the Java clients as well - give it a try!</p>
</blockquote>
<p>Extract the <code>LoadBalancer</code> public IP for Kafka cluster</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">KAFKA_CLUSTER_NAME</span><span class="o">=</span>my-kafka-cluster

kubectl get service/<span class="si">${</span><span class="nv">KAFKA_CLUSTER_NAME</span><span class="si">}</span>-kafka-external-bootstrap --output<span class="o">=</span><span class="nv">jsonpath</span><span class="o">={</span>.status.loadBalancer.ingress<span class="o">[</span>0<span class="o">]</span>.ip<span class="o">}</span>
</code></pre></div><p>Create a file called <code>client-ssl.properties</code> with the following contents:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">bootstrap.servers<span class="o">=[</span>LOADBALANCER_PUBLIC_IP<span class="o">]</span>:9094
security.protocol<span class="o">=</span>SSL
ssl.truststore.location<span class="o">=[</span>TRUSTSTORE_LOCATION<span class="o">]</span>
//for JDK truststore, the default password is <span class="s2">&#34;changeit&#34;</span>
ssl.truststore.password<span class="o">=</span>changeit
</code></pre></div><p>To use the Kafka CLI, download <code>Kafka</code> if you don&rsquo;t have it already - <a href="https://kafka.apache.org/downloads">https://kafka.apache.org/downloads</a></p>
<p>All you need to do is use the <code>kafka-console-producer</code> and <code>kafka-console-consumer</code> by pointing it to the <code>client-ssl.properties</code> file you just created</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">KAFKA_HOME</span><span class="o">=[</span>replace with Kafka installation path<span class="o">]</span> e.g. /Users/foobar/kafka_2.12-2.3.0
<span class="nb">export</span> <span class="nv">LOADBALANCER_PUBLIC_IP</span><span class="o">=[</span>replace with public IP of Load Balancer<span class="o">]</span>
<span class="nb">export</span> <span class="nv">TOPIC_NAME</span><span class="o">=</span>test-strimzi-topic

<span class="c1"># on a terminal, start producer and send a few messages</span>
<span class="nv">$KAFKA_HOME</span>/bin/kafka-console-producer.sh --broker-list <span class="nv">$LOADBALANCER_PUBLIC_IP</span>:9094 --topic <span class="nv">$TOPIC_NAME</span> --producer.config client-ssl.properties

<span class="c1"># on another terminal, start consumer</span>
<span class="nv">$KAFKA_HOME</span>/bin/kafka-console-consumer.sh --bootstrap-server <span class="nv">$LOADBALANCER_PUBLIC_IP</span>:9094 --topic <span class="nv">$TOPIC_NAME</span> --consumer.config client-ssl.properties --from-beginning
</code></pre></div><p>You should see producer and consumer working in tandem. Great!</p>
<blockquote>
<p>If you face SSL Handshake errors, please check whether the CA cert has been correctly imported along with its correct password. If the Kafka cluster is not reachable, ensure you are using the right value for the public IP</p>
</blockquote>
<p>Now, let&rsquo;s try a programmatic client. Since the Java client behavior (required config properties) are same as the CLI, I am using a Go client to try something different. Don&rsquo;t worry, if you are not a Go programmer, it should be easy to follow along - I will not walk through the entire program, just the part where we create the connection related configuration.</p>
<p>Here is the snippet:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">    <span class="nx">bootstrapServers</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;KAFKA_BOOTSTRAP_SERVERS&#34;</span><span class="p">)</span>
    <span class="nx">caLocation</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;CA_CERT_LOCATION&#34;</span><span class="p">)</span>
    <span class="nx">topic</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;KAFKA_TOPIC&#34;</span><span class="p">)</span>

    <span class="nx">config</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">kafka</span><span class="p">.</span><span class="nx">ConfigMap</span><span class="p">{</span><span class="s">&#34;bootstrap.servers&#34;</span><span class="p">:</span> <span class="nx">bootstrapServers</span><span class="p">,</span> <span class="s">&#34;security.protocol&#34;</span><span class="p">:</span> <span class="s">&#34;SSL&#34;</span><span class="p">,</span> <span class="s">&#34;ssl.ca.location&#34;</span><span class="p">:</span> <span class="nx">caLocation</span><span class="p">}</span>
</code></pre></div><p>Notice that the <code>bootstrap.servers</code> and <code>security.protocol</code> are the same as ones you used in the Kafka CLI client (same for Java as well). The only difference is that <code>ssl.ca.location</code> is used to point to the CA certificate directly as opposed to a <code>truststore</code></p>
<p>If you have <code>Go</code> installed, you can try it out. Clone the Git repo&hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">git clone https://github.com/abhirockzz/kafka-kubernetes-strimzi
<span class="nb">cd</span> part-2/go-client-app
</code></pre></div><p>.. and run the program:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">export</span> <span class="nx">KAFKA_BOOTSTRAP_SERVERS</span><span class="p">=[</span><span class="nx">replace</span> <span class="nx">with</span> <span class="nx">loadbalancer_ip</span><span class="p">:</span><span class="mi">9094</span><span class="p">]</span> <span class="nx">e</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span> <span class="mf">42.42.424.424</span><span class="p">:</span><span class="mi">9094</span>
<span class="nx">export</span> <span class="nx">CA_CERT_LOCATION</span><span class="p">=[</span><span class="nx">replace</span> <span class="nx">with</span> <span class="nx">path</span> <span class="nx">to</span> <span class="nx">ca</span><span class="p">.</span><span class="nx">crt</span> <span class="nx">file</span> <span class="nx">which</span> <span class="nx">you</span> <span class="nx">downloaded</span><span class="p">]</span>
<span class="nx">export</span> <span class="nx">KAFKA_TOPIC</span><span class="p">=</span><span class="nx">test</span><span class="o">-</span><span class="nx">strimzi</span><span class="o">-</span><span class="nx">topic</span>

<span class="k">go</span> <span class="nx">run</span> <span class="nx">kafka</span><span class="o">-</span><span class="nx">client</span><span class="p">.</span><span class="k">go</span>
</code></pre></div><p>You should see logs similar to this and confirm that messages are being produced and consumed</p>
<blockquote>
<p>press <code>ctrl+c</code> to exit the app</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">started consumer
started producer delivery goroutine
started producer goroutine
delivered messaged test-strimzi-topic<span class="o">[</span>0<span class="o">]</span>@122
delivered messaged test-strimzi-topic<span class="o">[</span>0<span class="o">]</span>@123
delivered messaged test-strimzi-topic<span class="o">[</span>0<span class="o">]</span>@124
received message from test-strimzi-topic<span class="o">[</span>0<span class="o">]</span>@122: value-2020-06-08 16:23:05.913303 +0530 IST <span class="nv">m</span><span class="o">=</span>+0.020529419
received message from test-strimzi-topic<span class="o">[</span>0<span class="o">]</span>@123: value-2020-06-08 16:23:07.915252 +0530 IST <span class="nv">m</span><span class="o">=</span>+2.022455867
received message from test-strimzi-topic<span class="o">[</span>0<span class="o">]</span>@124: value-2020-06-08 16:23:09.915875 +0530 IST <span class="nv">m</span><span class="o">=</span>+4.023055601
received message from test-strimzi-topic<span class="o">[</span>0<span class="o">]</span>@125: value-2020-06-08 16:23:11.915977 +0530 IST <span class="nv">m</span><span class="o">=</span>+6.023134961
....
</code></pre></div><h2 id="thats-all-for-now-but-there-is-more-to-come">That&rsquo;s all for now, but there is more to come!</h2>
<p><img src="https://media.giphy.com/media/26u4lOMA8JKSnL9Uk/giphy.gif" alt=""></p>
<p>So we made some progress! We now have a Kafka cluster on Kubernetes which is publicly accessible but is (partially) secure thanks to TLS encryption. We also did some sanity testing using not one, but two (different) client applications. In the next part, we&rsquo;ll improve this further&hellip; stay tuned!</p>


        
          <div class="blog-tags">
            
              <a href="https://abhirockzz.github.io//tags/kafka/">kafka</a>&nbsp;
            
              <a href="https://abhirockzz.github.io//tags/kubernetes/">kubernetes</a>&nbsp;
            
              <a href="https://abhirockzz.github.io//tags/strimzi/">strimzi</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://abhirockzz.github.io/posts/kafka-kubernetes-strimzi-1/" data-toggle="tooltip" data-placement="top" title="Kafka on Kubernetes, the Strimzi way! (Part 1)">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://abhirockzz.github.io/posts/eventhubs-rbac/" data-toggle="tooltip" data-placement="top" title="Azure Event Hubs &#39;Role Based Access Control&#39; in action">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://github.com/abhirockzz" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/abhi_tweeter" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/abhirockzz" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://abhirockzz.github.io">Abhishek Gupta</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2021
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://abhirockzz.github.io/">Data Foo</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.80.0</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://abhirockzz.github.io/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://abhirockzz.github.io/js/load-photoswipe.js"></script>









    
  </body>
</html>

